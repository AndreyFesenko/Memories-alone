{
  "openapi": "3.0.1",
  "info": {
    "title": "Memories â€“ Unified API",
    "version": "1.0.0",
    "description": "API Gateway spec combining all microservices: Identity, Profile, MemoryArchive, Notification, AccessControl, AuditLogging"
  },
  "servers": [
    {
      "url": "http://localhost:8080",
      "description": "Local Gateway"
    }
  ],
  "tags": [
    { "name": "Identity" },
    { "name": "Profile" },
    { "name": "Memory" },
    { "name": "Notification" },
    { "name": "AccessControl" },
    { "name": "AuditLogging" },
    { "name": "System" }
  ],
  "security": [
    { "Bearer": [] }
  ],
  "paths": {
    "/health/live": {
      "get": {
        "tags": [ "System" ],
        "summary": "Gateway liveness",
        "operationId": "systemHealthLive",
        "security": [],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "example": { "status": "Live" }
              }
            }
          }
        }
      }
    },
    "/health/ready": {
      "get": {
        "tags": [ "System" ],
        "summary": "Gateway readiness",
        "operationId": "systemHealthReady",
        "security": [],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "example": { "status": "Ready" }
              }
            }
          }
        }
      }
    },

    "/identity/login": {
      "post": {
        "tags": [ "Identity" ],
        "summary": "User login (returns JWT)",
        "operationId": "identityLogin",
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/LoginRequest" },
              "example": {
                "username": "testuser",
                "password": "P@ssw0rd!"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Authenticated",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/JwtResponse" },
                "example": {
                  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
                  "refreshToken": "abc123refresh",
                  "expiresAt": "2025-09-01T12:00:00Z"
                }
              }
            }
          },
          "401": { "description": "Invalid credentials" }
        }
      }
    },
    "/identity/register": {
      "post": {
        "tags": [ "Identity" ],
        "summary": "Create a new user",
        "operationId": "identityRegister",
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/RegisterRequest" },
              "example": {
                "username": "andrey",
                "password": "andrey256!",
                "email": "andrey@andrey.com",
                "displayName": "andrey"
              }
            }
          }
        },
        "responses": {
          "201": { "description": "User created" },
          "409": { "description": "User already exists" }
        }
      }
    },
    "/identity/refresh": {
      "post": {
        "tags": [ "Identity" ],
        "summary": "Refresh JWT",
        "operationId": "identityRefresh",
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": { "$ref": "#/components/schemas/RefreshRequest" },
              "example": { "refreshToken": "abc123refresh" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "New token",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/JwtResponse" },
                "example": {
                  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
                  "refreshToken": "newRefresh123",
                  "expiresAt": "2025-09-01T13:00:00Z"
                }
              }
            }
          }
        }
      }
    },
    "/identity/me": {
      "get": {
        "tags": [ "Identity" ],
        "summary": "Get current user profile (from token)",
        "operationId": "identityMe",
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/MeResponse" },
                "example": {
                  "id": "8d3a5a26-1f4b-4df4-8f90-123456789abc",
                  "username": "testuser",
                  "email": "test@example.com",
                  "roles": [ "User" ]
                }
              }
            }
          },
          "401": { "description": "Unauthorized" }
        }
      }
    },

    "/profile/{userId}": {
      "get": {
        "tags": [ "Profile" ],
        "summary": "Get user profile by Id",
        "operationId": "profileGetById",
        "parameters": [
          {
            "name": "userId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Profile",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/UserProfile" },
                "example": {
                  "id": "8d3a5a26-1f4b-4df4-8f90-123456789abc",
                  "displayName": "John Doe",
                  "bio": "Hello, I'm John",
                  "accessMode": "AfterDeath"
                }
              }
            }
          },
          "404": { "description": "Not found" }
        }
      }
    },

    "/memory/api/memory": {
      "post": {
        "tags": [ "Memory" ],
        "summary": "Create memory",
        "operationId": "memoryCreate",
        "requestBody": {
          "required": true,
          "content": {
            "multipart/form-data": {
              "schema": { "$ref": "#/components/schemas/CreateMemoryForm" }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Created memory",
            "content": {
              "application/json": {
                "schema": { "$ref": "#/components/schemas/MemoryDto" },
                "example": {
                  "id": "77e8d7b3-5e5b-4a4c-9b8a-987654321def",
                  "ownerId": "8d3a5a26-1f4b-4df4-8f90-123456789abc",
                  "title": "Trip to Japan",
                  "description": "Photos from Tokyo",
                  "createdAt": "2025-08-01T12:00:00Z",
                  "tags": [ "travel", "japan" ],
                  "accessLevel": "Public"
                }
              }
            }
          }
        }
      }
    },

    "/notification/user/{userId}": {
      "get": {
        "tags": [ "Notification" ],
        "summary": "Get notifications for user",
        "operationId": "notificationGetForUser",
        "parameters": [
          {
            "name": "userId",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Notifications",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/Notification" }
                },
                "example": [
                  {
                    "id": "1",
                    "subject": "New Memory",
                    "body": "John shared a new memory",
                    "status": "unread",
                    "createdAt": "2025-09-01T10:00:00Z"
                  }
                ]
              }
            }
          }
        }
      }
    },

    "/access-control/api/rules": {
      "get": {
        "tags": [ "AccessControl" ],
        "summary": "List access rules",
        "operationId": "accessControlListRules",
        "responses": {
          "200": {
            "description": "Rules",
            "content": {
              "application/json": {
                "schema": {
                  "type": "array",
                  "items": { "$ref": "#/components/schemas/AccessRule" }
                },
                "example": [
                  {
                    "id": "a1b2c3d4-e5f6-7890-abcd-1234567890ef",
                    "subjectId": "8d3a5a26-1f4b-4df4-8f90-123456789abc",
                    "resourceId": "77e8d7b3-5e5b-4a4c-9b8a-987654321def",
                    "permission": "read",
                    "createdAt": "2025-08-01T12:00:00Z"
                  }
                ]
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "securitySchemes": {
      "Bearer": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Provide JWT as: Bearer {token}"
      }
    },
    "schemas": {
      "LoginRequest": {
        "type": "object",
        "properties": {
          "username": { "type": "string" },
          "password": { "type": "string" }
        }
      },
      "RegisterRequest": {
        "type": "object",
        "properties": {
          "username": { "type": "string" },
          "password": { "type": "string" },
          "email": { "type": "string" },
          "displayName": { "type": "string" }
        }
      },
      "RefreshRequest": {
        "type": "object",
        "properties": {
          "refreshToken": { "type": "string" }
        }
      },
      "JwtResponse": {
        "type": "object",
        "properties": {
          "accessToken": { "type": "string" },
          "refreshToken": { "type": "string" },
          "expiresAt": { "type": "string" }
        }
      },
      "MeResponse": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "username": { "type": "string" },
          "email": { "type": "string" },
          "roles": {
            "type": "array",
            "items": { "type": "string" }
          }
        }
      },
      "UserProfile": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "displayName": { "type": "string" },
          "bio": { "type": "string" }
        }
      },
      "CreateMemoryForm": {
        "type": "object",
        "properties": {
          "OwnerId": { "type": "string" },
          "Title": { "type": "string" },
          "File": {
            "type": "string",
            "format": "binary"
          }
        }
      },
      "MemoryDto": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "title": { "type": "string" }
        }
      },
      "Notification": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "subject": { "type": "string" },
          "body": { "type": "string" }
        }
      },
      "AccessRule": {
        "type": "object",
        "properties": {
          "id": { "type": "string" },
          "subjectId": { "type": "string" },
          "resourceId": { "type": "string" },
          "permission": { "type": "string" }
        }
      }
    }
  }
}
