<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Memories – Unified API</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --ink: #e5e7eb;
            --muted: #9ca3af;
            --accent: #22c55e
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font: 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif
        }

        header {
            display: flex;
            gap: 12px;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #1f2937;
            background: #0b1220;
            position: sticky;
            top: 0;
            z-index: 3
        }

            header h1 {
                font-size: 16px;
                margin: 0;
                font-weight: 600
            }

            header .env {
                font-size: 12px;
                color: var(--muted)
            }

        .env-controls {
            display: flex;
            gap: 8px;
            align-items: center
        }

        main {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 16px;
            padding: 16px;
            max-width: 1500px;
            margin: 0 auto
        }

        .card {
            background: var(--panel);
            border: 1px solid #1f2937;
            border-radius: 12px;
            overflow: hidden
        }

            .card h3 {
                margin: 0;
                padding: 12px 14px;
                border-bottom: 1px solid #1f2937;
                font-size: 13px;
                letter-spacing: .2px;
                color: #cbd5e1
            }

            .card .body {
                padding: 12px 14px;
                display: grid;
                gap: 10px
            }

        label {
            display: grid;
            gap: 6px;
            font-size: 12px;
            color: #cbd5e1
        }

        input[type="text"], input[type="url"], input[type="file"], select, textarea {
            width: 100%;
            background: #0b1220;
            color: var(--ink);
            border: 1px solid #1f2937;
            border-radius: 8px;
            padding: 9px 10px;
            font-size: 13px
        }

        textarea {
            min-height: 120px;
            resize: vertical
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--accent);
            border: none;
            color: #052e16;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer
        }

            .btn.secondary {
                background: #1f2937;
                color: #e5e7eb
            }

            .btn.small {
                padding: 4px 8px;
                font-size: 11px
            }

            .btn.ghost {
                background: #0b1220;
                border: 1px solid #1f2937;
                color: #cbd5e1
            }

        .tabs {
            display: flex;
            gap: 6px
        }

        .tab {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #1f2937;
            background: #0b1220;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700
        }

            .tab.active {
                background: #1f2937
            }

        pre, code {
            font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
            font-size: 12px
        }

        pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 520px;
            overflow: auto;
            background: #0b1220;
            border-top: 1px solid #1f2937;
            padding: 12px 14px
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 11px
        }

            .pill.get {
                background: #052e16;
                color: #86efac;
                border: 1px solid #166534
            }

            .pill.post {
                background: #111827;
                color: #93c5fd;
                border: 1px solid #1d4ed8
            }

        .muted {
            color: #9ca3af;
            font-size: 12px
        }

        .divider {
            height: 1px;
            background: #1f2937;
            margin: 8px 0
        }

        .hint {
            font-size: 11px;
            color: #a3a3a3
        }

        .inline {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px
        }

        .file-preview {
            font-size: 12px;
            color: #cbd5e1;
            background: #0b1220;
            border: 1px dashed #334155;
            border-radius: 8px;
            padding: 8px
        }

        .preview {
            margin: 0;
            padding: 12px 14px;
            border-top: 1px solid #1f2937
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(160px,1fr));
            gap: 8px
        }

        .preview-item {
            background: #0b1220;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 8px;
            overflow: hidden
        }

            .preview-item img, .preview-item video {
                width: 100%;
                height: 130px;
                object-fit: cover;
                border-radius: 8px;
                display: block
            }

            .preview-item audio {
                width: 100%;
                display: block
            }

            .preview-item .meta {
                font-size: 11px;
                color: #9ca3af;
                margin-top: 6px;
                word-break: break-word
            }

            .preview-item a {
                text-decoration: none;
                color: #93c5fd;
                font-size: 12px
            }

        .tiny {
            font-size: 11px;
            color: #9ca3af
        }

        /* docs */
        .doc {
            max-width: 1500px;
            margin: 16px auto;
        }

            .doc details {
                background: #0b1220;
                border: 1px solid #1f2937;
                border-radius: 10px;
                padding: 8px 10px
            }

                .doc details + details {
                    margin-top: 10px
                }

            .doc summary {
                cursor: pointer;
                font-weight: 700;
                color: #cbd5e1
            }

        .mono {
            font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
            font-size: 12px
        }
    </style>
</head>
<body>
    <header>
        <div class="inline">
            <h1>Memories – Unified API</h1>
            <span class="env">Gateway: <code id="gatewayDisplay">http://localhost:8080</code></span>
        </div>

        <div class="env-controls">
            <label class="muted" for="envSelect" style="margin:0 4px 0 0">ENV</label>
            <select id="envSelect" title="Выберите окружение">
                <option value="dev">dev</option>
                <option value="stage">stage</option>
                <option value="prod">prod</option>
            </select>

            <button id="quickLogin" class="btn small" title="Открыть Identity → Login и выполнить">Quick Login</button>

            <div style="width:12px"></div>

            <div class="tabs" id="tabs">
                <button class="tab" data-tab="identity">Identity</button>
                <button class="tab" data-tab="memory">MemoryArchive</button>
                <button class="tab" data-tab="access">AccessControl</button>
                <button class="tab active" data-tab="audit">AuditLogging</button>
                <button class="tab" data-tab="notification">Notification</button>
                <button class="tab" data-tab="profile">ProfileService</button>
                <button class="tab" data-tab="moderation">Moderation</button>
                <button class="tab" data-tab="publicview">PublicView</button>
            </div>
        </div>
    </header>

    <main>
        <!-- LEFT -->
        <section class="card">
            <h3>Запрос</h3>
            <div class="body" id="reqPane">
                <div class="row">
                    <label>Метод <select id="method"></select></label>
                    <label>Endpoint <select id="endpoint"></select></label>
                </div>

                <label>
                    URL (через Gateway)
                    <input id="url" type="url" />
                    <span id="urlHint" class="hint"></span>
                </label>

                <div class="inline">
                    <label style="flex:1">
                        Authorization (Bearer)
                        <input id="auth" type="text" placeholder="вставьте JWT без 'Bearer '" />
                    </label>
                    <button class="btn small secondary" id="copyJwt" title="Скопировать токен">📋</button>
                </div>
                <span class="hint">JWT сохраняется в localStorage. Для защищённых маршрутов (Memory, Profile, Access, Audit) — обязателен.</span>

                <label class="inline">
                    <input type="checkbox" id="persistBodies" />
                    <span class="hint">Сохранять тело запроса между эндпоинтами</span>
                </label>

                <div id="jsonBlock">
                    <label>JSON Body<textarea id="json" spellcheck="false"></textarea></label>
                </div>

                <div id="formBlock" style="display:none;">
                    <div class="grid2">
                        <label>OwnerId<input id="OwnerId" type="text" placeholder="uuid" /></label>
                        <label>Title<input id="Title" type="text" /></label>
                        <label>Description<textarea id="Description"></textarea></label>
                        <label>
                            MediaType
                            <select id="MediaType">
                                <option>Image</option>
                                <option>Video</option>
                                <option>Audio</option>
                                <option>Document</option>
                            </select>
                        </label>
                        <label>
                            AccessLevel
                            <select id="AccessLevel">
                                <option>Private</option>
                                <option>Public</option>
                                <option>FriendsOnly</option>
                            </select>
                        </label>
                        <label>Tags (через запятую)<input id="Tags" type="text" placeholder="tag1,tag2" /></label>
                        <label>Файл<input id="File" type="file" /></label>
                        <label>FileName (опц.)<input id="FileName" type="text" /></label>
                    </div>
                    <div class="file-preview" id="filePreview">Файл не выбран</div>
                </div>

                <div class="row">
                    <button class="btn" id="send">Отправить</button>
                    <button class="btn secondary" id="fill">Заполнить пример</button>
                </div>

                <div class="divider"></div>
                <div class="inline">
                    <label style="flex:1">
                        Сгенерированный curl
                        <textarea id="curl" readonly></textarea>
                    </label>
                    <button class="btn small secondary" id="copyCurl" title="Скопировать curl">📋</button>
                </div>
            </div>
        </section>

        <!-- RIGHT -->
        <section class="card">
            <h3>Ответ</h3>
            <div class="body">
                <div class="inline"><span class="muted">HTTP Status:</span><span id="status" class="pill get">—</span></div>
                <label>Заголовки<textarea id="respHeaders" readonly></textarea></label>
            </div>
            <h3>Тело ответа</h3>
            <pre><code id="resp" class="language-json">—</code></pre>

            <div id="preview" class="preview" style="display:none;">
                <div class="toolbar" id="previewToolbar" style="display:none;">
                    <button class="btn small ghost" id="openAll">Открыть всё</button>
                    <button class="btn small ghost" id="copyIds">Скопировать mediaId</button>
                    <button class="btn small ghost" id="downloadAll">Скачать всё (zip)</button>
                    <span class="tiny" id="dlHint" style="display:none;"></span>
                </div>
                <h4>Медиа</h4>
                <div class="preview-grid" id="previewGrid"></div>
            </div>
        </section>
    </main>

    <!-- Documentation / Cheatsheet / Errors -->
    <section class="card doc">
        <h3>Памятка для фронтенда — сервисы, экшены, контракты</h3>
        <div class="body">
            <!-- Identity -->
            <details open>
                <summary>Identity — /identity</summary>
                <pre class="mono">
Назначение: аутентификация, выдача JWT (access + refresh). Лучше вызывать первым — Login.

• Login — получить accessToken/refreshToken.
POST /identity/login
Request:
{
  "username": "Admin",
  "password": "Admin!123"
}
Response 200:
{
  "accessToken": "ey...",
  "refreshToken": "...",
  "expiresIn": 3600
}
Комментарий: используйте первым — токен кладём в Authorization (Bearer).

• Register — регистрация.
POST /identity/register
Request:
{ "username":"user1", "password":"User1!pass", "email":"u1@example.com", "displayName":"User 1" }
Response 200: { "userId": "guid" }

• Refresh — обновление токена.
POST /identity/refresh
Request: { "refreshToken": "..." }
Response: { "accessToken":"..." }

• Me — данные текущего пользователя.
GET /identity/me
Response 200: { "id":"guid", "username":"...", "email":"...", "displayName":"..." }
                </pre>
            </details>

            <!-- ProfileService -->
            <details>
                <summary>ProfileService — /profile/api/profile</summary>
                <pre class="mono">
Назначение: хранение профилей пользователей (1:1 с user). Требует JWT.

• CreateProfile
POST /profile/api/profile
Request:
{
  "userId":"guid",
  "fullName":"string",
  "birthDate":"ISO8601",
  "displayName":"string?",
  "bio":"string?",
  "accessMode":"AfterDeath|Anytime",
  "avatarUrl":"string?"
}
Response 201: UserProfileDto

• GetById
GET /profile/api/profile/{id}
200 UserProfileDto | 404

• GetByUser
GET /profile/api/profile/by-user/{userId}
200 UserProfileDto | 404

• Update
PUT /profile/api/profile/{id}
Request: same as create (id path)
200 UserProfileDto | 404

• Delete
DELETE /profile/api/profile/{id}
204

• ConfirmDeath
POST /profile/api/profile/{userId}/confirm-death
200 { "message": "Death confirmed" }
                </pre>
            </details>

            <!-- MemoryArchive -->
            <details>
                <summary>MemoryArchive — /memory/api</summary>
                <pre class="mono">
Назначение: хранение воспоминаний и медиа.

• CreateMemory (multipart)
POST /memory/api/memory
FormData fields:
OwnerId (uuid), Title, Description, MediaType, AccessLevel, Tags (repeatable), File (@file), FileName (opt)
Response 201: MemoryDto (с mediaFiles)

• GetMemoryById
GET /memory/api/memory/{memoryId}
200 MemoryDto | 404

• UpdateMemory
PUT /memory/api/memory/{memoryId}
JSON body with updated fields
200 MemoryDto

• DeleteMemory
DELETE /memory/api/memory/{memoryId}
204

• Media endpoints: upload, get, update, delete (/media/{mediaId})
                </pre>
            </details>

            <!-- AccessControl -->
            <details>
                <summary>AccessControl — /access-control</summary>
                <pre class="mono">
Назначение: выдача/проверка/отзыв прав на ресурсы.

• Grant
POST /access-control/api/access/grant
{ subjectId, subjectType, resourceType, resourceId, permission, expiresAt? }
→ 200

• Revoke
POST /access-control/api/access/revoke
→ 200

• Check
POST /access-control/api/access/check
{ subjectId, resourceType, resourceId, permission }
→ 200 { allowed: true/false }
                </pre>
            </details>

            <!-- AuditLogging -->
            <details>
                <summary>AuditLogging — /audit-logging</summary>
                <pre class="mono">
Назначение: запись и поиск событий аудита.

• Create
POST /audit-logging/auditlogs
→ 201

• Search
GET /audit-logging/auditlogs?query...
→ 200 { items: [...], total: n }

• GetById
GET /audit-logging/auditlogs/{id}
→ 200
                </pre>
            </details>

            <!-- Notification -->
            <details>
                <summary>Notification — /notification</summary>
                <pre class="mono">
Назначение: отправка уведомлений (интеграции с пуш/сервисами).

• NotifyUser
POST /notification/api/Notification/notify
{ userId, subject, body, type, channel?, data? }
→ 200

• NotifyUsers
POST /notification/api/Notification/notify-many
{ userIds: [...], subject, body, type }
→ 200
                </pre>
            </details>

            <!-- Moderation -->
            <details>
                <summary>Moderation — /moderation (новая вкладка)</summary>
                <pre class="mono">
Назначение: отправка контента на модерацию, принятие решений.

• CreateReview — отправить контент на модерацию.
POST /moderation/api/reviews
Request:
{
  "resourceType":"Memory|Profile|Comment",
  "resourceId":"guid",
  "content":"string (текст/JSON)",
  "metadataJson":"string?",    // опционально
  "createdBy":"userId?"
}
Response 201: ReviewDto
Кратко: отправляем публикацию/пользовательский контент на проверку.

• GetReview
GET /moderation/api/reviews/{id}
200 ReviewDto | 404
Кратко: получить статус и детали ревью.

• ListReviews
GET /moderation/api/reviews?status=Pending&page=1&pageSize=20
200 { items: [...], total: N }
Кратко: список ревью (фильтр по статусу).

• DecideReview — принять/отклонить.
POST /moderation/api/reviews/{id}/decide
Request:
{ "decision":"Approved|Rejected", "moderatorId":"id", "reason":"string?" }
Response 200: ReviewDto
Кратко: выставляем результат модерации и причину.
                </pre>
            </details>

            <!-- PublicView -->
            <details>
                <summary>PublicView — /public (новая вкладка)</summary>
                <pre class="mono">
Назначение: публичные read-only представления (статичные страницы / открытые данные).

• GetPublicProfile
GET /public/api/profile/{userId}
Response 200:
{
  "userId":"guid",
  "displayName":"string",
  "bio":"string",
  "avatarUrl":"string?"
}
Кратко: публичные данные профиля (без приватных полей).

• GetPublicMemory
GET /public/api/memory/{memoryId}
Response 200:
{
  "id":"guid",
  "title":"string",
  "description":"string",
  "mediaFiles":[{id,fileName,mediaType,url}]
}
Кратко: данные записи, доступные для публичного просмотра.
                </pre>
            </details>

            <div class="hint">
                Для защищённых маршрутов (Identity/Memory/Profile/Access/Audit) добавляйте заголовок:
                <code>Authorization: Bearer &lt;accessToken&gt;</code>. Плейсхолдеры <code>{id}</code>, <code>{userId}</code>,
                <code>{memoryId}</code>, <code>{mediaId}</code> подставляются автоматически в генераторе curl.
            </div>
        </div>
    </section>

    <section class="card doc">
        <h3>Типовые ошибки и решения</h3>
        <div class="body">
            <details open>
                <summary>401 invalid_token / 401 Unauthorized</summary>
                <pre class="mono">
Симптом: ответ 401 + header WWW-Authenticate: Bearer error="invalid_token", error_description="The signature key was not found"

Причины:
- Токен просрочен.
- Ключ подписи (Jwt:Key / jwks) не совпадает между Identity и сервисом.
- Audience/Issuer mismatch (aud/iss в токене не совпадают с ожидаемыми).
- Токен подписан другим алгоритмом/ключом.

Решение:
1) Убедиться, что вы получили accessToken из Identity (Login) и подставили в Authorization.
2) Сверить конфигурацию Jwt в сервисах: Key/Issuer/Audience должны соответствовать данным Identity (или использовать JWKS).
3) Если Gateway проверяет токен — проверьте настройки forward/пасск через Authorization.
                </pre>
            </details>

            <details>
                <summary>403 Forbidden</summary>
                <pre class="mono">
Симптом: 403 — токен валиден, но доступ закрыт (policy/role/ownership).

Причины:
- Политика авторизации отвергла запрос (e.g. запись принадлежит другому пользователю).
- Роль или claim отсутствует.

Решение:
- Проверить claims в token (roles, sub, scope).
- Проверить политики в сервисе (Authorization handlers).
- Для отладки вывести информацию о токене (claims) в лог.
                </pre>
            </details>

            <details>
                <summary>404 Not Found</summary>
                <pre class="mono">
Симптом: 404 при запросе ресурса.

Причины:
- Неверный id (userId вместо profileId и т.п.).
- Gateway убрал префикс, а сервис ожидает путь с префиксом (или наоборот).
- Ресурс ещё не создан.

Решение:
1) Убедитесь в корректности URL (проверьте какие префиксы убирает Gateway: PathRemovePrefix).
2) Проверьте параметры запроса (id, userId).
3) Включите детальные логи сервиса и Gateway для сверки пришедших путей.
                </pre>
            </details>

            <details>
                <summary>415 Unsupported Media Type</summary>
                <pre class="mono">
Симптом: 415 при попытке залить файл/JSON.

Причины:
- Используете JSON вместо multipart/form-data для загрузки файлов.
- Content-Type не выставлен.

Решение:
- Для upload (CreateMemory / UploadMedia) используйте FormData + заголовок Content-Type автоматически выставит браузер.
- Для JSON-запросов выставьте Content-Type: application/json.
                </pre>
            </details>

            <details>
                <summary>500 Internal Server Error (общие рекомендации)</summary>
                <pre class="mono">
- Посмотрите body ответа — иногда API возвращает JSON с traceId и message.
- Проверьте логи сервиса (DeveloperExceptionPage / application logs).
- Часто 500 приходит при ошибках конфигурации (DB connection, missing env vars).
                </pre>
            </details>
        </div>
    </section>

    <script>
        (() => {
            hljs.highlightAll();

            // UI elements
            const envSelect = document.getElementById('envSelect'),
                gatewayDisplay = document.getElementById('gatewayDisplay'),
                quickLoginBtn = document.getElementById('quickLogin'),

                method = document.getElementById('method'),
                endpointSel = document.getElementById('endpoint'),
                url = document.getElementById('url'), urlHint = document.getElementById('urlHint'),
                auth = document.getElementById('auth'), json = document.getElementById('json'),
                jsonBlock = document.getElementById('jsonBlock'), formBlock = document.getElementById('formBlock'),
                fileInput = document.getElementById('File'), filePreview = document.getElementById('filePreview'),
                sendBtn = document.getElementById('send'), fillBtn = document.getElementById('fill'),
                curlBox = document.getElementById('curl'), respEl = document.getElementById('resp'),
                statusEl = document.getElementById('status'), respHeaders = document.getElementById('respHeaders'),
                tabs = document.getElementById('tabs'), persistBodies = document.getElementById('persistBodies'),
                preview = document.getElementById('preview'), previewGrid = document.getElementById('previewGrid'),
                previewToolbar = document.getElementById('previewToolbar');

            // environment presets (gateway + optional service-specific bases)
            const ENV_PRESETS = {
                dev: {
                    name: 'dev',
                    gateway: 'http://localhost:8080',
                    services: {
                        identity: 'http://localhost:8080',
                        profile: 'http://localhost:8080',
                        memory: 'http://localhost:8080',
                        access: 'http://localhost:8080',
                        audit: 'http://localhost:8080',
                        notification: 'http://localhost:8080',
                        moderation: 'http://localhost:8080',
                        publicview: 'http://localhost:8080'
                    }
                },
                stage: {
                    name: 'stage',
                    gateway: 'https://stage.api.memories.local',
                    services: {
                        identity: 'https://stage.api.memories.local',
                        profile: 'https://stage.api.memories.local',
                        memory: 'https://stage.api.memories.local',
                        access: 'https://stage.api.memories.local',
                        audit: 'https://stage.api.memories.local',
                        notification: 'https://stage.api.memories.local',
                        moderation: 'https://stage.api.memories.local',
                        publicview: 'https://stage.api.memories.local'
                    }
                },
                prod: {
                    name: 'prod',
                    gateway: 'https://api.memories.app',
                    services: {
                        identity: 'https://identity.memories.app',
                        profile: 'https://api.memories.app',
                        memory: 'https://api.memories.app',
                        access: 'https://api.memories.app',
                        audit: 'https://api.memories.app',
                        notification: 'https://api.memories.app',
                        moderation: 'https://api.memories.app',
                        publicview: 'https://api.memories.app'
                    }
                }
            };

            const LS_JWT_KEY = 'memories.jwt';
            const LS_PERSIST = 'memories.persist';
            let currentEnvKey = 'dev';
            let currentTab = 'audit', currentEndpointKey = '';

            function getServiceBase(service) {
                const env = ENV_PRESETS[currentEnvKey];
                return (env && env.services && env.services[service]) ? env.services[service] : env.gateway;
            }

            // endpoints (all tabs) — добавлены moderation и publicview
            const endpoints = {
                identity: {
                    login: {
                        label: 'Login', method: 'POST', service: 'identity', path: '/identity/login', mode: 'json',
                        json: { username: 'Admin', password: 'Admin!123' },
                        hint: 'Выдаёт accessToken/refreshToken — используйте первым, чтобы получить JWT.'
                    },
                    register: {
                        label: 'Register', method: 'POST', service: 'identity', path: '/identity/register', mode: 'json',
                        json: { username: 'user1', password: 'User1!pass', email: 'u1@example.com', displayName: 'User 1' },
                        hint: 'Регистрация нового пользователя.'
                    },
                    refresh: {
                        label: 'Refresh', method: 'POST', service: 'identity', path: '/identity/refresh', mode: 'json',
                        json: { refreshToken: '<your-refresh-token>' }, hint: 'Обновление accessToken по refreshToken.'
                    },
                    me: { label: 'Me', method: 'GET', service: 'identity', path: '/identity/me', mode: 'none', hint: 'Возвращает текущего пользователя по токену.' }
                },

                memory: {
                    create: {
                        label: 'CreateMemory (multipart)', method: 'POST', service: 'memory', path: '/memory/api/memory', mode: 'form',
                        form: { OwnerId: 'fdd2eee1-7871-45da-a3b4-c6a214ef4928', Title: 'Trip to Alps', Description: 'Ski weekend', MediaType: 'Image', AccessLevel: 'Private', Tags: 'alps,trip' },
                        hint: 'Создать запись с файлом (FormData + File).'
                    },
                    get: { label: 'GetMemoryById', method: 'GET', service: 'memory', path: '/memory/api/memory/1f6cbd66-dc14-4c35-a1f1-94928a4caa5f', mode: 'none', hint: 'Получить запись по id.' },
                    update: {
                        label: 'UpdateMemory', method: 'PUT', service: 'memory', path: '/memory/api/memory/{memoryId}', mode: 'json',
                        json: { title: 'New title', description: 'Updated', accessLevel: 'Public', tags: ['alps', 'winter'] }, hint: 'Обновить метаданные.'
                    },
                    delete: { label: 'DeleteMemory', method: 'DELETE', service: 'memory', path: '/memory/api/memory/{memoryId}', mode: 'none', hint: 'Удалить запись.' },

                    upload: {
                        label: 'UploadMedia (multipart)', method: 'POST', service: 'memory', path: '/memory/api/memory/{memoryId}/media', mode: 'form',
                        form: { MediaType: 'Image', FileName: 'pic1.jpg' }, hint: 'Загрузить файл к записи.'
                    },
                    mediaGet: { label: 'GetMediaById', method: 'GET', service: 'memory', path: '/memory/api/media/{mediaId}', mode: 'none', hint: 'Метаданные медиа.' },
                    mediaUpd: { label: 'UpdateMedia', method: 'PUT', service: 'memory', path: '/memory/api/memory/{memoryId}/media/{mediaId}', mode: 'json', json: { fileName: 'renamed.jpg', mediaType: 'Image' }, hint: 'Переименовать медиа.' },
                    mediaDel: { label: 'DeleteMedia', method: 'DELETE', service: 'memory', path: '/memory/api/memory/{memoryId}/media/{mediaId}', mode: 'none', hint: 'Удалить медиа.' },

                    listUser: { label: 'ListByUser', method: 'GET', service: 'memory', path: '/memory/api/memory/user/fdd2eee1-7871-45da-a3b4-c6a214ef4928?page=1&pageSize=10', mode: 'none', hint: 'Список записей пользователя.' }
                },

                access: {
                    grant: { label: 'Grant', method: 'POST', service: 'access', path: '/access-control/api/access/grant', mode: 'json', json: { subjectId: '4beed3da-37f8-423b-a16b-5a0fea4bbc38', subjectType: 'User', resourceType: 'Memory', resourceId: '17e5b201-d562-4c5c-b90f-414349bca627', permission: 'Edit' }, hint: 'Выдать право на ресурс.' },
                    revoke: { label: 'Revoke', method: 'POST', service: 'access', path: '/access-control/api/access/revoke', mode: 'json', json: { subjectId: '4beed3da-37f8-423b-a16b-5a0fea4bbc38', subjectType: 'User', resourceType: 'Memory', resourceId: '17e5b201-d562-4c5c-b90f-414349bca627', permission: 'Edit' }, hint: 'Отозвать право.' },
                    check: { label: 'Check', method: 'POST', service: 'access', path: '/access-control/api/access/check', mode: 'json', json: { subjectId: '8bfbdace-33b7-4764-9903-39a6dc48bf7d', resourceType: 'Memory', resourceId: '17e5b201-d562-4c5c-b90f-414349bca627', permission: 'Edit' }, hint: 'Проверить право.' },
                    shares: { label: 'List Shares', method: 'GET', service: 'access', path: '/access-control/api/access/memory/17e5b201-d562-4c5c-b90f-414349bca627/shares', mode: 'none', hint: 'Посмотреть все доступы к памяти.' }
                },

                audit: {
                    create: {
                        label: 'Create', method: 'POST', service: 'audit', path: '/audit-logging/auditlogs', mode: 'json',
                        json: { action: 'Access.Revoke', target: 'Memory:42', details: 'revoked by admin', result: 'success', data: '{"extra":"value"}', userId: '00000000-0000-0000-0000-000000000000', timestamp: new Date().toISOString(), ipAddress: '127.0.0.1', userAgent: 'UnifiedAPI UI' },
                        hint: 'Создать запись аудита.'
                    },
                    search: { label: 'Search', method: 'GET', service: 'audit', path: '/audit-logging/auditlogs', mode: 'none', hint: 'Поиск событий аудита.' },
                    getById: { label: 'GetById', method: 'GET', service: 'audit', path: '/audit-logging/auditlogs/0cf44724-b65d-48da-a340-0c0cb653503c', mode: 'none', hint: 'Получить событие аудита.' },
                    delete: { label: 'Delete', method: 'DELETE', service: 'audit', path: '/audit-logging/auditlogs/{id}', mode: 'none', hint: 'Удалить запись.' }
                },

                notification: {
                    notifyUser: { label: 'NotifyUser', method: 'POST', service: 'notification', path: '/notification/api/Notification/notify', mode: 'json', json: { userId: 'fdd2eee1-7871-45da-a3b4-c6a214ef4928', subject: 'Hello!', body: 'You have a new message', type: 'General' }, hint: 'Отправить уведомление одному пользователю.' },
                    notifyUsers: { label: 'NotifyUsers', method: 'POST', service: 'notification', path: '/notification/api/Notification/notify-many', mode: 'json', json: { userIds: ['fdd2eee1-7871-45da-a3b4-c6a214ef4928', '00000000-0000-0000-0000-000000000124'], subject: 'Maintenance', body: 'System maintenance at 22:00', type: 'SystemAlert' }, hint: 'Отправить уведомления группе пользователей.' },
                    broadcast: { label: 'Broadcast (501)', method: 'POST', service: 'notification', path: '/notification/api/Notification/broadcast', mode: 'json', json: { subject: 'Global notice', body: 'We are deploying a new version', type: 'SystemAlert' }, hint: 'Широковещательная рассылка (не реализовано).' },
                    health: { label: 'Health (ready)', method: 'GET', service: 'notification', path: '/notification/health/ready', mode: 'none', hint: 'Проверка готовности сервиса.' }
                },

                profile: {
                    create: { label: 'CreateProfile', method: 'POST', service: 'profile', path: '/profile/api/profile', mode: 'json', json: { userId: '00000000-0000-0000-0000-000000000003', fullName: 'John Doe', birthDate: '1990-05-20T00:00:00Z', displayName: 'JD', bio: 'Hello there', accessMode: 'AfterDeath', avatarUrl: null }, hint: 'Создаёт профиль пользователя.' },
                    getById: { label: 'GetById', method: 'GET', service: 'profile', path: '/profile/api/profile/{id}', mode: 'none', hint: 'Получить профиль по id.' },
                    getByUser: { label: 'GetByUserId', method: 'GET', service: 'profile', path: '/profile/api/profile/by-user/{userId}', mode: 'none', hint: 'Получить профиль по userId.' },
                    update: { label: 'UpdateProfile', method: 'PUT', service: 'profile', path: '/profile/api/profile/{id}', mode: 'json', json: { id: '00000000-0000-0000-0000-000000000005', fullName: 'Johnathan Doe', birthDate: '1990-05-20T00:00:00Z', displayName: 'Johnny', bio: 'Updated bio', accessMode: 'AfterDeath', avatarUrl: null }, hint: 'Обновить поля профиля.' },
                    delete: { label: 'DeleteProfile', method: 'DELETE', service: 'profile', path: '/profile/api/profile/{id}', mode: 'none', hint: 'Удалить профиль.' },
                    confirmDeath: { label: 'ConfirmDeath', method: 'POST', service: 'profile', path: '/profile/api/profile/{userId}/confirm-death', mode: 'none', hint: 'Отметить пользователя как DeathConfirmed.' }
                },

                moderation: {
                    create: { label: 'CreateReview', method: 'POST', service: 'moderation', path: '/moderation/api/reviews', mode: 'json', json: { resourceType: 'Memory', resourceId: '00000000-0000-0000-0000-000000000010', content: 'Sample content' }, hint: 'Отправить контент на модерацию.' },
                    get: { label: 'GetReview', method: 'GET', service: 'moderation', path: '/moderation/api/reviews/{id}', mode: 'none', hint: 'Получить ревью по id.' },
                    list: { label: 'ListReviews', method: 'GET', service: 'moderation', path: '/moderation/api/reviews?status=Pending&page=1&pageSize=20', mode: 'none', hint: 'Список ревью (фильтр по статусу).' },
                    decide: { label: 'DecideReview', method: 'POST', service: 'moderation', path: '/moderation/api/reviews/{id}/decide', mode: 'json', json: { decision: 'Approved', moderatorId: 'mod-1', reason: 'ok' }, hint: 'Принять или отклонить ревью.' }
                },

                publicview: {
                    profile: { label: 'PublicProfile', method: 'GET', service: 'publicview', path: '/public/api/profile/{userId}', mode: 'none', hint: 'Публичные данные профиля.' },
                    memory: { label: 'PublicMemory', method: 'GET', service: 'publicview', path: '/public/api/memory/{memoryId}', mode: 'none', hint: 'Публичные данные памяти.' }
                }
            };

            // helper: replace placeholders with examples
            function ph(u) {
                return (u || '')
                    .replace('{memoryId}', '00000000-0000-0000-0000-000000000001')
                    .replace('{mediaId}', '00000000-0000-0000-0000-000000000002')
                    .replace('{userId}', '00000000-0000-0000-0000-000000000003')
                    .replace('{subjectId}', '00000000-0000-0000-0000-000000000004')
                    .replace('{id}', '00000000-0000-0000-0000-000000000005');
            }

            function buildFullUrl(p) {
                const base = getServiceBase(p.service || 'gateway') || ENV_PRESETS[currentEnvKey].gateway;
                if (p.path.startsWith('http://') || p.path.startsWith('https://')) return p.path;
                return base.replace(/\/$/, '') + p.path;
            }

            function fillMethodList() {
                method.innerHTML = '';
                ['GET', 'POST', 'PUT', 'DELETE'].forEach(m => {
                    const o = document.createElement('option'); o.value = m; o.textContent = m; method.appendChild(o);
                });
            }

            function fillEndpointList(tab) {
                endpointSel.innerHTML = '';
                Object.entries(endpoints[tab]).forEach(([k, v]) => {
                    const o = document.createElement('option'); o.value = k; o.textContent = v.label; endpointSel.appendChild(o);
                });
                currentEndpointKey = Object.keys(endpoints[tab])[0];
                endpointSel.value = currentEndpointKey;
            }

            function setMode(mode) {
                const isJson = mode === 'json', isForm = mode === 'form';
                jsonBlock.style.display = isJson ? '' : 'none';
                formBlock.style.display = isForm ? '' : 'none';
                updateCurl();
            }

            function applyPreset(tab, key) {
                const p = endpoints[tab][key]; if (!p) return;
                method.value = p.method;
                const full = buildFullUrl(p);
                url.value = full;
                urlHint.textContent = p.hint || '';
                setMode(p.mode);
                if (p.mode === 'json') {
                    json.value = typeof p.json === 'string' ? p.json : JSON.stringify(p.json || {}, null, 2);
                }
                if (p.mode === 'form') {
                    document.getElementById('OwnerId').value = p.form?.OwnerId ?? '';
                    document.getElementById('Title').value = p.form?.Title ?? '';
                    document.getElementById('Description').value = p.form?.Description ?? '';
                    document.getElementById('MediaType').value = p.form?.MediaType ?? 'Image';
                    document.getElementById('AccessLevel').value = p.form?.AccessLevel ?? 'Private';
                    document.getElementById('Tags').value = p.form?.Tags ?? '';
                    document.getElementById('FileName').value = p.form?.FileName ?? '';
                    fileInput.value = ''; filePreview.textContent = 'Файл не выбран';
                }
                updateCurl();
            }

            function escSh(s) { return (s || '').replace(/'/g, `'\"'\"'`); }

            function buildCurl() {
                const m = method.value, u = ph(url.value);
                const token = (auth.value || '').trim();
                const parts = [`curl -X '${m}' \\`, `  '${u}' \\`];
                if (token) parts.push(`  -H 'Authorization: Bearer ${escSh(token)}' \\`);

                if (jsonBlock.style.display !== 'none') {
                    parts.push(`  -H 'Content-Type: application/json' \\`);
                    if (json.value) parts.push(`  -d '${escSh(json.value)}'`);
                } else if (formBlock.style.display !== 'none') {
                    const ownerId = document.getElementById('OwnerId').value;
                    const title = document.getElementById('Title').value;
                    const description = document.getElementById('Description').value;
                    const mediaType = document.getElementById('MediaType').value;
                    const accessLevel = document.getElementById('AccessLevel').value;
                    const tags = document.getElementById('Tags').value;
                    const fileName = document.getElementById('FileName').value;

                    const toF = (k, v) => v ? `  -F '${k}=${escSh(v)}' \\` : '';
                    parts.push(toF('OwnerId', ownerId));
                    parts.push(toF('Title', title));
                    parts.push(toF('Description', description));
                    parts.push(toF('MediaType', mediaType));
                    parts.push(toF('AccessLevel', accessLevel));
                    if (tags) tags.split(',').map(t => t.trim()).filter(Boolean).forEach(t => parts.push(`  -F 'Tags=${escSh(t)}' \\`));
                    if (fileInput.files?.length) {
                        const f = fileInput.files[0];
                        parts.push(`  -F 'File=@${escSh(f.name)}' \\`);
                    } else {
                        parts.push(`  -F 'File=@<path-to-file>' \\`);
                    }
                    if (fileName) parts.push(`  -F 'FileName=${escSh(fileName)}' \\`);
                    if (parts[parts.length - 1].endsWith('\\')) parts[parts.length - 1] = parts[parts.length - 1].slice(0, -2);
                }
                return parts.filter(Boolean).join('\n');
            }

            function updateCurl() { curlBox.value = buildCurl(); }

            async function sendRequest() {
                sendBtn.disabled = true; statusEl.textContent = '…'; statusEl.className = 'pill ' + (method.value === 'GET' ? 'get' : 'post');
                preview.style.display = 'none'; previewGrid.innerHTML = ''; previewToolbar.style.display = 'none';
                try {
                    const u = ph(url.value);
                    const token = (auth.value || '').trim();
                    const headers = new Headers();
                    if (token) headers.set('Authorization', `Bearer ${token}`);

                    let init = { method: method.value, headers };
                    if (jsonBlock.style.display !== 'none') {
                        headers.set('Content-Type', 'application/json');
                        init.body = json.value || '';
                    } else if (formBlock.style.display !== 'none') {
                        const fd = new FormData();
                        const ownerId = document.getElementById('OwnerId').value;
                        const title = document.getElementById('Title').value;
                        const description = document.getElementById('Description').value;
                        const mediaType = document.getElementById('MediaType').value;
                        const accessLevel = document.getElementById('AccessLevel').value;
                        const tags = document.getElementById('Tags').value;
                        const fileName = document.getElementById('FileName').value;
                        if (ownerId) fd.append('OwnerId', ownerId);
                        if (title) fd.append('Title', title);
                        if (description) fd.append('Description', description);
                        if (mediaType) fd.append('MediaType', mediaType);
                        if (accessLevel) fd.append('AccessLevel', accessLevel);
                        if (tags) tags.split(',').map(t => t.trim()).filter(Boolean).forEach(t => fd.append('Tags', t));
                        if (fileInput.files?.length) fd.append('File', fileInput.files[0], fileInput.files[0].name || 'upload.bin');
                        if (fileName) fd.append('FileName', fileName);
                        init.body = fd;
                    }

                    const res = await fetch(u, init);
                    statusEl.textContent = res.status + ' ' + res.statusText;

                    const hdrs = []; res.headers.forEach((v, k) => hdrs.push(`${k}: ${v}`)); respHeaders.value = hdrs.join('\n');

                    const ct = res.headers.get('content-type') || '';
                    let text;
                    if (ct.includes('application/json')) {
                        const j = await res.json().catch(() => ({}));
                        if (j && j.accessToken) { auth.value = j.accessToken; localStorage.setItem(LS_JWT_KEY, j.accessToken); }
                        text = JSON.stringify(j, null, 2);
                        tryRenderPreview(j);
                    } else {
                        text = await res.text();
                    }
                    respEl.textContent = text || '—'; hljs.highlightElement(respEl);
                } catch (e) {
                    statusEl.textContent = 'ERR';
                    respEl.textContent = String(e); hljs.highlightElement(respEl);
                } finally {
                    sendBtn.disabled = false; updateCurl();
                }
            }

            function tryRenderPreview(obj) {
                const mf = (obj && obj.mediaFiles) ? obj.mediaFiles
                    : (Array.isArray(obj?.items) && obj.items.length && obj.items[0]?.mediaFiles) ? obj.items[0].mediaFiles
                        : [];
                if (!Array.isArray(mf) || !mf.length) return;

                preview.style.display = 'block'; previewToolbar.style.display = 'flex';
                previewGrid.innerHTML = '';
                for (const m of mf) {
                    const item = document.createElement('div'); item.className = 'preview-item';
                    let media = ''; const mt = (m.mediaType || '').toLowerCase();
                    if (mt.includes('image')) media = `<img src="${m.url || '#'}" alt="${m.fileName || m.id}" />`;
                    else if (mt.includes('video')) media = `<video src="${m.url || '#'}" controls></video>`;
                    else if (mt.includes('audio')) media = `<audio src="${m.url || '#'}" controls></audio>`;
                    else media = `<a href="${m.url || '#'}" target="_blank">Открыть файл</a>`;
                    item.innerHTML = `${media}<div class="meta">${m.fileName || ''}<br>${m.mediaType || ''}</div>`;
                    previewGrid.appendChild(item);
                }
            }

            // events
            sendBtn.addEventListener('click', sendRequest);
            fillBtn.addEventListener('click', () => applyPreset(currentTab, currentEndpointKey));
            endpointSel.addEventListener('change', () => { currentEndpointKey = endpointSel.value; applyPreset(currentTab, currentEndpointKey); });
            tabs.addEventListener('click', e => {
                const b = e.target.closest('[data-tab]'); if (!b) return;
                [...tabs.children].forEach(x => x.classList.toggle('active', x === b));
                currentTab = b.dataset.tab; fillEndpointList(currentTab); applyPreset(currentTab, Object.keys(endpoints[currentTab])[0]);
            });
            ['change', 'input'].forEach(ev => { method.addEventListener(ev, updateCurl); url.addEventListener(ev, updateCurl); auth.addEventListener(ev, updateCurl); json.addEventListener(ev, updateCurl); });

            document.getElementById('copyJwt').addEventListener('click', () => navigator.clipboard.writeText(auth.value || ''));
            document.getElementById('copyCurl').addEventListener('click', () => navigator.clipboard.writeText(curlBox.value || ''));
            persistBodies.addEventListener('change', () => localStorage.setItem(LS_PERSIST, persistBodies.checked ? '1' : '0'));
            fileInput.addEventListener('change', () => {
                if (fileInput.files?.length) { const f = fileInput.files[0]; filePreview.textContent = `${f.name} (${f.type || 'binary'}, ${f.size} bytes)`; }
                else filePreview.textContent = 'Файл не выбран';
                updateCurl();
            });

            // ENV change handling
            envSelect.addEventListener('change', () => {
                currentEnvKey = envSelect.value;
                const env = ENV_PRESETS[currentEnvKey];
                gatewayDisplay.textContent = env.gateway;
                applyPreset(currentTab, currentEndpointKey);
            });

            // Quick Login: switch to Identity → Login, apply preset and auto-send
            quickLoginBtn.addEventListener('click', async () => {
                const targetTabBtn = [...tabs.children].find(b => b.dataset.tab === 'identity');
                if (targetTabBtn) targetTabBtn.click();
                currentEndpointKey = 'login';
                endpointSel.value = 'login';
                applyPreset('identity', 'login');
                try { await sendRequest(); } catch (e) { console.error(e); }
            });

            // init
            (function init() {
                const savedJwt = localStorage.getItem(LS_JWT_KEY); if (savedJwt) auth.value = savedJwt;
                persistBodies.checked = (localStorage.getItem(LS_PERSIST) === '1');

                fillMethodList();
                envSelect.value = currentEnvKey;
                gatewayDisplay.textContent = ENV_PRESETS[currentEnvKey].gateway;

                // default starting tab: Identity -> Login (user requested)
                currentTab = 'identity';
                fillEndpointList('identity');
                endpointSel.value = 'login'; currentEndpointKey = 'login';
                applyPreset('identity', 'login');

                // visual highlight
                [...tabs.children].forEach(x => x.classList.toggle('active', x.dataset.tab === 'identity'));
            })();
        })();
    </script>
</body>
</html>
