<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Memories ‚Äì Unified API</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --ink: #e5e7eb;
            --muted: #9ca3af;
            --accent: #22c55e
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--ink);
            font: 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif
        }

        header {
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid #1f2937;
            background: #0b1220;
            position: sticky;
            top: 0;
            z-index: 3
        }

            header h1 {
                font-size: 16px;
                margin: 0;
                font-weight: 600
            }

            header .env {
                font-size: 12px;
                color: var(--muted)
            }

        main {
            display: grid;
            grid-template-columns: 360px 1fr;
            gap: 16px;
            padding: 16px;
            max-width: 1500px;
            margin: 0 auto
        }

        .card {
            background: var(--panel);
            border: 1px solid #1f2937;
            border-radius: 12px;
            overflow: hidden
        }

            .card h3 {
                margin: 0;
                padding: 12px 14px;
                border-bottom: 1px solid #1f2937;
                font-size: 13px;
                letter-spacing: .2px;
                color: #cbd5e1
            }

            .card .body {
                padding: 12px 14px;
                display: grid;
                gap: 10px
            }

        label {
            display: grid;
            gap: 6px;
            font-size: 12px;
            color: #cbd5e1
        }

        input[type="text"], input[type="url"], input[type="file"], select, textarea {
            width: 100%;
            background: #0b1220;
            color: var(--ink);
            border: 1px solid #1f2937;
            border-radius: 8px;
            padding: 9px 10px;
            font-size: 13px
        }

        textarea {
            min-height: 120px;
            resize: vertical
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--accent);
            border: none;
            color: #052e16;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer
        }

            .btn.secondary {
                background: #1f2937;
                color: #e5e7eb
            }

            .btn.small {
                padding: 4px 8px;
                font-size: 11px
            }

            .btn.ghost {
                background: #0b1220;
                border: 1px solid #1f2937;
                color: #cbd5e1
            }

        .tabs {
            display: flex;
            gap: 6px
        }

        .tab {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #1f2937;
            background: #0b1220;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700
        }

            .tab.active {
                background: #1f2937
            }

        pre, code {
            font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
            font-size: 12px
        }

        pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 520px;
            overflow: auto;
            background: #0b1220;
            border-top: 1px solid #1f2937;
            padding: 12px 14px
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 999px;
            font-weight: 600;
            font-size: 11px
        }

            .pill.get {
                background: #052e16;
                color: #86efac;
                border: 1px solid #166534
            }

            .pill.post {
                background: #111827;
                color: #93c5fd;
                border: 1px solid #1d4ed8
            }

        .muted {
            color: #9ca3af;
            font-size: 12px
        }

        .divider {
            height: 1px;
            background: #1f2937;
            margin: 8px 0
        }

        .hint {
            font-size: 11px;
            color: #a3a3a3
        }

        .inline {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px
        }

        kbd {
            background: #0b1220;
            border: 1px solid #1f2937;
            border-radius: 6px;
            padding: 2px 6px;
            font-size: 11px
        }

        .file-preview {
            font-size: 12px;
            color: #cbd5e1;
            background: #0b1220;
            border: 1px dashed #334155;
            border-radius: 8px;
            padding: 8px
        }

        .preview {
            margin: 0;
            padding: 12px 14px;
            border-top: 1px solid #1f2937
        }

            .preview .toolbar {
                display: flex;
                gap: 8px;
                align-items: center;
                justify-content: flex-start;
                margin-bottom: 8px;
                flex-wrap: wrap
            }

            .preview h4 {
                margin: 0 0 8px 0;
                font-size: 13px;
                color: #cbd5e1
            }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill,minmax(160px,1fr));
            gap: 8px
        }

        .preview-item {
            background: #0b1220;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 8px;
            overflow: hidden
        }

            .preview-item img, .preview-item video {
                width: 100%;
                height: 130px;
                object-fit: cover;
                border-radius: 8px;
                display: block
            }

            .preview-item audio {
                width: 100%;
                display: block
            }

            .preview-item .meta {
                font-size: 11px;
                color: #9ca3af;
                margin-top: 6px;
                word-break: break-word
            }

            .preview-item a {
                text-decoration: none;
                color: #93c5fd;
                font-size: 12px
            }

        .tiny {
            font-size: 11px;
            color: #9ca3af
        }

        /* –Ω–∏–∂–Ω–∏–µ —Å–µ–∫—Ü–∏–∏ (–≤–Ω–µ grid) */
        .doc {
            max-width: 1500px;
            margin: 16px auto;
        }

            .doc details {
                background: #0b1220;
                border: 1px solid #1f2937;
                border-radius: 10px;
                padding: 8px 10px;
            }

                .doc details + details {
                    margin-top: 10px
                }

            .doc summary {
                cursor: pointer;
                font-weight: 700;
                color: #cbd5e1
            }

        .mono {
            font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
            font-size: 12px
        }
    </style>
</head>
<body>
    <header>
        <div class="inline">
            <h1>Memories ‚Äì Unified API</h1>
            <span class="env">Gateway: <code>http://localhost:8080</code></span>
        </div>
        <div class="tabs" id="tabs">
            <button class="tab active" data-tab="identity">Identity</button>
            <button class="tab" data-tab="memory">MemoryArchive</button>
            <button class="tab" data-tab="access">AccessControl</button>
            <button class="tab" data-tab="audit">AuditLogging</button>
            <button class="tab" data-tab="notification">Notification</button>
            <button class="tab" data-tab="profile">ProfileService</button>
        </div>
    </header>

    <main>
        <!-- LEFT -->
        <section class="card">
            <h3>–ó–∞–ø—Ä–æ—Å</h3>
            <div class="body" id="reqPane">
                <div class="row">
                    <label>–ú–µ—Ç–æ–¥ <select id="method"></select></label>
                    <label>Endpoint <select id="endpoint"></select></label>
                </div>

                <label>
                    URL (—á–µ—Ä–µ–∑ Gateway)
                    <input id="url" type="url" />
                    <span id="urlHint" class="hint"></span>
                </label>

                <div class="inline">
                    <label style="flex:1">
                        Authorization (Bearer)
                        <input id="auth" type="text" placeholder="–≤—Å—Ç–∞–≤—å—Ç–µ JWT –±–µ–∑ 'Bearer '" />
                    </label>
                    <button class="btn small secondary" id="copyJwt" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω">üìã</button>
                </div>
                <span class="hint">JWT —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage. –î–ª—è /identity/me, Memory, Access, Profile ‚Äî –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.</span>

                <label class="inline">
                    <input type="checkbox" id="persistBodies" />
                    <span class="hint">–°–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –º–µ–∂–¥—É —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏</span>
                </label>

                <div id="jsonBlock">
                    <label>JSON Body<textarea id="json" spellcheck="false"></textarea></label>
                </div>

                <div id="formBlock" style="display:none;">
                    <div class="grid2">
                        <label>OwnerId<input id="OwnerId" type="text" placeholder="uuid" /></label>
                        <label>Title<input id="Title" type="text" /></label>
                        <label>Description<textarea id="Description"></textarea></label>
                        <label>
                            MediaType
                            <select id="MediaType">
                                <option>Image</option>
                                <option>Video</option>
                                <option>Audio</option>
                                <option>Document</option>
                            </select>
                        </label>
                        <label>
                            AccessLevel
                            <select id="AccessLevel">
                                <option>Private</option>
                                <option>Public</option>
                                <option>FriendsOnly</option>
                            </select>
                        </label>
                        <label>Tags (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)<input id="Tags" type="text" placeholder="tag1,tag2" /></label>
                        <label>–§–∞–π–ª<input id="File" type="file" /></label>
                        <label>FileName (–æ–ø—Ü.)<input id="FileName" type="text" /></label>
                    </div>
                    <div class="file-preview" id="filePreview">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
                </div>

                <div class="row">
                    <button class="btn" id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <button class="btn secondary" id="fill">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
                </div>

                <div class="divider"></div>
                <div class="inline">
                    <label style="flex:1">
                        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π curl
                        <textarea id="curl" readonly></textarea>
                    </label>
                    <button class="btn small secondary" id="copyCurl" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å curl">üìã</button>
                </div>
            </div>
        </section>

        <!-- RIGHT -->
        <section class="card">
            <h3>–û—Ç–≤–µ—Ç</h3>
            <div class="body">
                <div class="inline"><span class="muted">HTTP Status:</span><span id="status" class="pill get">‚Äî</span></div>
                <label>–ó–∞–≥–æ–ª–æ–≤–∫–∏<textarea id="respHeaders" readonly></textarea></label>
            </div>
            <h3>–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞</h3>
            <pre><code id="resp" class="language-json">‚Äî</code></pre>

            <div id="preview" class="preview" style="display:none;">
                <div class="toolbar" id="previewToolbar" style="display:none;">
                    <button class="btn small ghost" id="openAll">–û—Ç–∫—Ä—ã—Ç—å –≤—Å—ë</button>
                    <button class="btn small ghost" id="copyIds">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å mediaId</button>
                    <button class="btn small ghost" id="downloadAll">–°–∫–∞—á–∞—Ç—å –≤—Å—ë (zip)</button>
                    <span class="tiny" id="dlHint" style="display:none;"></span>
                </div>
                <h4>–ú–µ–¥–∏–∞</h4>
                <div class="preview-grid" id="previewGrid"></div>
            </div>
        </section>
    </main>

    <!-- ====== –ü–ê–ú–Ø–¢–ö–ê ‚Äî –ö–û–ù–¢–†–ê–ö–¢–´ ====== -->
    <section class="card doc">
        <h3>–ü–∞–º—è—Ç–∫–∞ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ ‚Äî —Å–µ—Ä–≤–∏—Å—ã, —ç–∫—à–µ–Ω—ã, –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã</h3>
        <div class="body">

            <details open>
                <summary>ProfileService ‚Äî /profile/api/profile</summary>
<pre class="mono">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è (1:1 c –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º). –¢—Ä–µ–±—É–µ—Ç JWT.

‚Ä¢ CreateProfile ‚Äî –°–û–ó–î–ê–Å–¢ –ø—Ä–æ—Ñ–∏–ª—å.
POST /profile/api/profile
Request:
{
  "userId": "guid",
  "fullName": "string",
  "birthDate": "2025-01-01T00:00:00Z",
  "displayName": "string?",
  "bio": "string?",
  "accessMode": "Anytime | AfterDeath",
  "avatarUrl": "string?"
}
Response 201:
{ "id":"guid", "userId":"guid", "fullName":"...", "birthDate":"ISO", "displayName":"?", "bio":"?", "deathConfirmed":false,
  "accessMode":"AfterDeath", "createdAt":"ISO", "updatedAt":null, "avatarUrl":"?" }

‚Ä¢ GetById ‚Äî –ü–û–õ–£–ß–ò–¢–¨ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –ø—Ä–æ—Ñ–∏–ª—è.
GET /profile/api/profile/{id}
‚Üí 200 UserProfileDto | 404

‚Ä¢ GetByUserId ‚Äî –ü–û–õ–£–ß–ò–¢–¨ –ø—Ä–æ—Ñ–∏–ª—å –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
GET /profile/api/profile/by-user/{userId}
‚Üí 200 UserProfileDto | 404

‚Ä¢ UpdateProfile ‚Äî –û–ë–ù–û–í–ò–¢–¨ –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è.
PUT /profile/api/profile/{id}
Request: { "id":"guid", "fullName":"...", "birthDate":"ISO", "displayName":"?", "bio":"?", "accessMode":"Anytime|AfterDeath", "avatarUrl":"?" }
‚Üí 200 UserProfileDto | 404

‚Ä¢ DeleteProfile ‚Äî –£–î–ê–õ–ò–¢–¨ –ø—Ä–æ—Ñ–∏–ª—å.
DELETE /profile/api/profile/{id}
‚Üí 204

‚Ä¢ ConfirmDeath ‚Äî –ü–û–ú–ï–¢–ò–¢–¨ —Å—Ç–∞—Ç—É—Å 'DeathConfirmed'.
POST /profile/api/profile/{userId}/confirm-death
‚Üí 200 { "message": "Death confirmed" }</pre>
            </details>

            <details>
                <summary>Identity ‚Äî /identity</summary>
<pre class="mono">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –≤—ã–¥–∞—á–∞ JWT.

‚Ä¢ Login ‚Äî –ø–æ–ª—É—á–∏—Ç—å accessToken/refreshToken (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–≤—ã–º).
POST /identity/login
{ "username":"...", "password":"..." }
‚Üí 200 { "accessToken":"jwt", "refreshToken":"...", "expiresIn":3600 }

‚Ä¢ Register ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
POST /identity/register
{ "username":"...", "password":"...", "email":"...", "displayName":"..." }
‚Üí 200 { "userId":"guid" }

‚Ä¢ Refresh ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ accessToken –ø–æ refreshToken.
POST /identity/refresh
{ "refreshToken":"..." }
‚Üí 200 { "accessToken":"jwt" }

‚Ä¢ Me ‚Äî –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑ —Ç–æ–∫–µ–Ω–∞).
GET /identity/me
‚Üí 200 { "id":"guid", "username":"...", "email":"...", "displayName":"..." }</pre>
            </details>

            <details>
                <summary>MemoryArchive ‚Äî /memory/api</summary>
<pre class="mono">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã—Ö –º–µ–¥–∏–∞.

‚Ä¢ CreateMemory ‚Äî —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å —Å —Ñ–∞–π–ª–æ–º (multipart/form-data).
POST /memory/api/memory
Fields: OwnerId(uuid), Title, Description, MediaType(Image|Video|Audio|Document),
        AccessLevel(Private|Public|FriendsOnly), Tags(repeatable), File(@file), FileName(opt)
‚Üí 201 { "id":"guid","ownerId":"guid","title":"...","mediaFiles":[{ "id":"guid","fileName":"...","mediaType":"image/jpeg","url":"..." }] }

‚Ä¢ GetMemoryById ‚Äî –ø–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å—å.
GET /memory/api/memory/{memoryId}
‚Üí 200 MemoryDto | 404

‚Ä¢ UpdateMemory ‚Äî –∏–∑–º–µ–Ω–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏.
PUT /memory/api/memory/{memoryId}
{ "title":"...", "description":"...", "accessLevel":"...", "tags":["a","b"] }
‚Üí 200 MemoryDto

‚Ä¢ DeleteMemory ‚Äî —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å.
DELETE /memory/api/memory/{memoryId}
‚Üí 204

‚Ä¢ UploadMedia ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª –∫ –∑–∞–ø–∏—Å–∏ (multipart).
POST /memory/api/memory/{memoryId}/media
Fields: MediaType, File(@file), FileName(opt)
‚Üí 201 MediaDto

‚Ä¢ GetMediaById ‚Äî –ø–æ–ª—É—á–∏—Ç—å –º–µ–¥–∏–∞ –ø–æ id.
GET /memory/api/media/{mediaId}
‚Üí 200 MediaDto | 404

‚Ä¢ UpdateMedia ‚Äî –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å/–∏–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø.
PUT /memory/api/memory/{memoryId}/media/{mediaId}
{ "fileName":"...", "mediaType":"Image|Video|Audio|Document" }
‚Üí 200 MediaDto

‚Ä¢ DeleteMedia ‚Äî —É–¥–∞–ª–∏—Ç—å –º–µ–¥–∏–∞.
DELETE /memory/api/memory/{memoryId}/media/{mediaId}
‚Üí 204

‚Ä¢ ListByUser ‚Äî —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
GET /memory/api/memory/user/{userId}?page=1&pageSize=10[&accessLevel=...]
‚Üí 200 { "items":[...], "total":123 }</pre>
            </details>

            <details>
                <summary>AccessControl ‚Äî /access-control/api</summary>
<pre class="mono">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —Ä–µ—Å—É—Ä—Å—ã.

‚Ä¢ Grant ‚Äî –≤—ã–¥–∞—Ç—å –ø—Ä–∞–≤–æ –Ω–∞ —Ä–µ—Å—É—Ä—Å.
POST /access-control/api/access/grant
{ "subjectId":"guid","subjectType":"User","resourceType":"Memory","resourceId":"guid","permission":"Read|Edit|...","expiresAt":null }
‚Üí 200/204

‚Ä¢ Revoke ‚Äî –æ—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–æ.
POST /access-control/api/access/revoke
{ "subjectId":"guid","subjectType":"User","resourceType":"Memory","resourceId":"guid","permission":"..." }
‚Üí 204

‚Ä¢ Check ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–æ.
POST /access-control/api/access/check
{ "subjectId":"guid","resourceType":"Memory","resourceId":"guid","permission":"..." }
‚Üí 200 { "allowed": true }

‚Ä¢ List Shares ‚Äî —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≤—ã–¥–∞–Ω–Ω—ã—Ö –ø—Ä–∞–≤ –ø–æ –ø–∞–º—è—Ç–∏.
GET /access-control/api/access/memory/{id}/shares
‚Üí 200 [{ "subjectId":"guid", "permission":"Read", "expiresAt":null }]</pre>
            </details>

            <details>
                <summary>AuditLogging ‚Äî /audit-logging</summary>
<pre class="mono">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –∞—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π, –ø–æ–∏—Å–∫, —á—Ç–µ–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ.

‚Ä¢ Create ‚Äî –∑–∞–ø–∏—Å–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ –∞—É–¥–∏—Ç–∞.
POST /audit-logging/auditlogs
{ "action":"Access.Revoke","target":"Memory:42","details":"...","result":"success|fail",
  "data":"json-string","userId":"guid","timestamp":"ISO","ipAddress":"...","userAgent":"..." }
‚Üí 201 { "id":"guid", ... }

‚Ä¢ Search ‚Äî –ø–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π –∞—É–¥–∏—Ç–∞.
GET /audit-logging/auditlogs[?action=&userId=&from=&to=&offset=&limit=]
‚Üí 200 { "items":[...], "total":123 }

‚Ä¢ GetById ‚Äî –ø–æ–ª—É—á–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –ø–æ id.
GET /audit-logging/auditlogs/{id}
‚Üí 200 { ... } | 404

‚Ä¢ Delete ‚Äî —É–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ.
DELETE /audit-logging/auditlogs/{id}
‚Üí 204</pre>
            </details>

            <details>
                <summary>Notification ‚Äî /notification/api/Notification</summary>
<pre class="mono">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.

‚Ä¢ NotifyUser ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
POST /notification/api/Notification/notify
{ "userId":"guid","subject":"...","body":"...","type":"General|SystemAlert","channel":"InApp?","data":{"url":"/..."} }
‚Üí 202/200

‚Ä¢ NotifyUsers ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
POST /notification/api/Notification/notify-many
{ "userIds":["guid","guid2"], "subject":"...", "body":"...", "type":"SystemAlert" }
‚Üí 202/200

‚Ä¢ Broadcast ‚Äî —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ).
POST /notification/api/Notification/broadcast
{ "subject":"...", "body":"...", "type":"SystemAlert" }
‚Üí 501 Not Implemented

‚Ä¢ Health (ready) ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞.
GET /notification/health/ready
‚Üí 200 {"status":"Healthy"}</pre>
            </details>

            <div class="hint">
                –î–ª—è –∑–∞—â–∏—â—ë–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –¥–æ–±–∞–≤–ª—è–π—Ç–µ <code>Authorization: Bearer &lt;jwt&gt;</code>. –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã
                <code>{id}</code>, <code>{userId}</code>, <code>{memoryId}</code>, <code>{mediaId}</code> –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è
                –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–µ curl (–ª–µ–≤–∞—è –ø–∞–Ω–µ–ª—å).
            </div>
        </div>
    </section>

    <!-- ====== –¢–ò–ü–û–í–´–ï –û–®–ò–ë–ö–ò –ò –†–ï–®–ï–ù–ò–Ø ====== -->
    <section class="card doc">
        <h3>–¢–∏–ø–æ–≤—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ä–µ—à–µ–Ω–∏—è</h3>
        <div class="body">
            <details open>
                <summary>ProfileService</summary>
<pre class="mono">401 invalid_token ‚Äî "The signature key was not found"
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: HS256/RS256 mismatch, –¥—Ä—É–≥–æ–π —Å–µ–∫—Ä–µ—Ç, –Ω–µ–≤–µ—Ä–Ω—ã–π aud/iss, –ª–∏–±–æ Gateway –Ω–µ –ø—Ä–æ–∫–∏–Ω—É–ª –∑–∞–≥–æ–ª–æ–≤–æ–∫.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: HS256 ‚Äî –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π Jwt:Key/Secret c Identity; RS256 ‚Äî Jwt:Authority + JWKS. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å iss/aud –≤ payload.

401 unauthorized ‚Äî "No authenticationScheme..." / –ø—É—Å—Ç–æ–π Bearer
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω AddAuthentication/UseAuthentication –∏–ª–∏ –Ω–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ Authorization.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å —Å—Ö–µ–º—É JWT –≤ Program.cs –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å Bearer.

403 forbidden
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –µ—Å—Ç—å, –Ω–æ –Ω–µ—Ç –ø—Ä–∞–≤ (–ø–æ–ª–∏—Ç–∏–∫–∏/—Ä–æ–ª–∏/–≤–ª–∞–¥–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª–µ–º).
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: —É—Ç–æ—á–Ω–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫—É –∏ —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

404 not found
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –≤ /profile/{id} –ø–µ—Ä–µ–¥–∞–Ω userId; –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ —Å–æ–∑–¥–∞–Ω.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: —Å–Ω–∞—á–∞–ª–∞ GET /profile/by-user/{userId}, –∞ –∑–∞—Ç–µ–º /profile/{profileId}.

415 unsupported media type
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ 'application/json'.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –≤—ã—Å—Ç–∞–≤–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Content-Type.</pre>
            </details>

            <details>
                <summary>Identity</summary>
<pre class="mono">400 bad request
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: —Å–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å/–≤–∞–ª–∏–¥–∞—Ü–∏—è.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –ø–æ–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—è.

401 unauthorized
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –∫—Ä–µ–¥—ã, –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π refresh, –Ω–µ—Ç Authorization.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å, –æ–±–Ω–æ–≤–∏—Ç—å refresh, –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫.

429 too many requests
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –ª–∏–º–∏—Ç—ã –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞/refresh.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: —Å–Ω–∏–∑–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É.</pre>
            </details>

            <details>
                <summary>MemoryArchive</summary>
<pre class="mono">400 bad request
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ–≤–µ—Ä–Ω—ã–µ –ø–æ–ª—è (MediaType –∏ —Ç.–ø.).
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –ø—Ä–∏–≤–µ—Å—Ç–∏ payload.

401 unauthorized
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ—Ç JWT/–Ω–µ –ø—Ä–æ–∫–∏–Ω—É—Ç —á–µ—Ä–µ–∑ Gateway.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å Authorization, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ.

404 not found
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π memoryId/mediaId.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç—ã create/list.

415 unsupported media type
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: JSON –≤–º–µ—Å—Ç–æ multipart, –ª–∏–±–æ —Ñ–∞–π–ª –Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å multipart/form-data c File.</pre>
            </details>

            <details>
                <summary>AccessControl</summary>
<pre class="mono">400 bad request
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π subjectType/resourceType/permission.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: —Å–≤–µ—Ä–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è.

401 unauthorized
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ—Ç JWT.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å Authorization.

403 forbidden
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ—Ç –ø—Ä–∞–≤ —É–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ—Å—Ç—É–ø–æ–º.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: —Ä–æ–ª—å/–≤–ª–∞–¥–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–º.

404 not found
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: —Ä–µ—Å—É—Ä—Å/–ø—Ä–∞–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å resourceId/—Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞.</pre>
            </details>

            <details>
                <summary>AuditLogging</summary>
<pre class="mono">400 bad request
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: timestamp –Ω–µ ISO, data –Ω–µ —Å—Ç—Ä–æ–∫–∞.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –ø—Ä–∏–≤–µ—Å—Ç–∏ —Ç–∏–ø—ã.

401 unauthorized
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ—Ç JWT (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ).
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å Authorization.

404 not found
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π id –ø—Ä–∏ GetById/Delete.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: —Å–≤–µ—Ä–∏—Ç—å id.

415 unsupported media type
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: Content-Type –Ω–µ 'application/json'.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: —É–∫–∞–∑–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫.</pre>
            </details>

            <details>
                <summary>Notification</summary>
<pre class="mono">400 bad request
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –ø—É—Å—Ç–æ–π userIds, –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π type.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –∑–∞–ø–æ–ª–Ω–∏—Ç—å userIds, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π type.

401 unauthorized
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: —Å–µ—Ä–≤–∏—Å –∑–∞—â–∏—â—ë–Ω, –∞ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –¥–æ–±–∞–≤–∏—Ç—å Authorization.

501 not implemented (broadcast)
  ‚Ä¢ –ü—Ä–∏—á–∏–Ω–∞: –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —à–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω—É—é —Ä–∞—Å—Å—ã–ª–∫—É.
  ‚Ä¢ –†–µ—à–µ–Ω–∏–µ: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å notify/notify-many.</pre>
            </details>
        </div>
    </section>

    <!-- ====== FAQ –ü–û GATEWAY ====== -->
    <section class="card doc">
        <h3>FAQ –ø–æ Gateway (–ø—Ä–æ–∫—Å–∏)</h3>
        <div class="body">
            <details open>
                <summary>Authorization / Bearer</summary>
                <div class="muted">–ó–∞–≥–æ–ª–æ–≤–æ–∫ <code>Authorization: Bearer &lt;jwt&gt;</code> –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –µ—Å—Ç—å.</div>
<pre class="mono">–ü—Ä–æ–≤–µ—Ä—å –≤ –∫–æ–Ω—Ñ–∏–≥–µ –ø—Ä–æ–∫—Å–∏:
‚Ä¢ –ù–ï –≤—ã—Ä–µ–∑–∞—Ç—å/–Ω–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å 'Authorization'.
‚Ä¢ –ï—Å–ª–∏ –µ—Å—Ç—å re-write, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –±–µ–∑ "Basic" –∫–æ–Ω–≤–µ—Ä—Å–∏–π.
‚Ä¢ –î–ª—è CORS –¥–æ–±–∞–≤–∏—Ç—å 'Authorization' –≤ allowed headers.</pre>
            </details>

            <details>
                <summary>CORS</summary>
<pre class="mono">‚Ä¢ Access-Control-Allow-Origin: —É–∫–∞–∂–∏ —Ç–æ—á–Ω—ã–π Origin —Ñ—Ä–æ–Ω—Ç–∞ –∏–ª–∏ "*".
‚Ä¢ Access-Control-Allow-Headers: Authorization, Content-Type, X-Requested-With, ...
‚Ä¢ Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS
‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–π preflight (OPTIONS) –Ω–∞ Gateway –∏–ª–∏ —Å–µ—Ä–≤–∏—Å–µ.</pre>
            </details>

            <details>
                <summary>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞ (multipart/JSON)</summary>
<pre class="mono">‚Ä¢ –£—Å—Ç–∞–Ω–æ–≤–∏ –ª–∏–º–∏—Ç—ã —Ä–∞–∑–º–µ—Ä–∞ —Ç–µ–ª–∞ (body size) –¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤.
‚Ä¢ –î–ª—è Kestrel: Kestrel:Limits:MaxRequestBodySize
‚Ä¢ –ù–∞ Nginx/Ingress: client_max_body_size / request-size –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏.</pre>
            </details>

            <details>
                <summary>–¢–∞–π–º–∞—É—Ç—ã –∏ —Ä–µ—Ç—Ä–∞–∏</summary>
<pre class="mono">‚Ä¢ –ü—Ä–æ—Å—Ç–∞–≤—å connect/read/send timeouts –Ω–∞ —É—Ä–æ–≤–Ω–µ Gateway.
‚Ä¢ –î–ª—è –∑–∞–≥—Ä—É–∑–æ–∫ (multipart) —É–≤–µ–ª–∏—á—å timeouts.
‚Ä¢ –û—Ç–∫–ª—é—á–∏ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ —Ä–µ—Ç—Ä–∞–∏ –Ω–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ —Ç–æ–ª—å–∫–æ –º–µ—Ç–æ–¥—ã (GET).</pre>
            </details>

            <details>
                <summary>–ó–∞–≥–æ–ª–æ–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª–µ–∑–Ω–æ –ø—Ä–æ–∫–∏–¥—ã–≤–∞—Ç—å</summary>
<pre class="mono">‚Ä¢ X-Forwarded-For / X-Real-IP
‚Ä¢ X-Forwarded-Proto / X-Forwarded-Host
‚Ä¢ X-Request-Id / Traceparent (–¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏)
‚Ä¢ User-Agent (–µ—Å–ª–∏ –Ω–µ –ø–æ–¥–º–µ–Ω—è–µ—Ç—Å—è)</pre>
            </details>

            <details>
                <summary>–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞</summary>
<pre class="mono">‚Ä¢ –õ–æ–≥–∏—Ä—É–π RequestId/Traceparent, —Å—Ç–∞—Ç—É—Å-–∫–æ–¥—ã, –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞.
‚Ä¢ –î–ª—è –ø—Ä–æ–±–ª–µ–º —Å —Ç–æ–∫–µ–Ω–∞–º–∏ ‚Äî –ª–æ–≥–∏—Ä—É–π –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑ —Ç–µ–ª–∞.
‚Ä¢ –í–∫–ª—é—á–∏ CORS/OPTIONS –ª–æ–≥–∏ –¥–ª—è –¥–µ–±–∞–≥–∞ —Ñ—Ä–æ–Ω—Ç–∞.</pre>
            </details>
        </div>
    </section>

    <!-- ====== CHEAT-SHEET: CURL / POWERSHELL ====== -->
    <section class="card doc">
        <h3>Cheat-sheet: curl / PowerShell</h3>
        <div class="body">
            <details open>
                <summary>curl ‚Äî JSON</summary>
<pre class="mono">POST JSON:
curl -X POST 'http://host/path' \
  -H 'Authorization: Bearer &lt;jwt&gt;' \
  -H 'Content-Type: application/json' \
  -d '{ "field": "value" }'

GET JSON:
curl -X GET 'http://host/path?param=1' \
  -H 'Authorization: Bearer &lt;jwt&gt;'</pre>
            </details>

            <details>
                <summary>curl ‚Äî multipart/form-data</summary>
<pre class="mono">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞:
curl -X POST 'http://host/path' \
  -H 'Authorization: Bearer &lt;jwt&gt;' \
  -F 'FieldA=Value' \
  -F 'File=@/full/path/to/file.jpg'</pre>
            </details>

            <details>
                <summary>PowerShell (Invoke-RestMethod)</summary>
<pre class="mono">$jwt = '...'
$headers = @{ Authorization = "Bearer $jwt" }

# POST JSON
$body = @{ field = 'value' } | ConvertTo-Json
Invoke-RestMethod -Method Post -Uri 'http://host/path' -Headers $headers -ContentType 'application/json' -Body $body

# GET
Invoke-RestMethod -Method Get -Uri 'http://host/path?param=1' -Headers $headers

# multipart (—Ñ–∞–π–ª)
$Form = @{
  FieldA = 'Value'
  File = Get-Item 'C:\path\file.jpg'
}
Invoke-RestMethod -Method Post -Uri 'http://host/path' -Headers $headers -Form $Form</pre>
            </details>
        </div>
    </section>

    <!-- ====== –û–ö–†–£–ñ–ï–ù–ò–Ø (DEV / STAGE / PROD) ====== -->
    <section class="card doc">
        <h3>–û–∫—Ä—É–∂–µ–Ω–∏—è (dev / stage / prod)</h3>
        <div class="body">
            <details open>
                <summary>–ë–∞–∑–æ–≤—ã–µ –∞–¥—Ä–µ—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤</summary>
<pre class="mono">DEV
‚Ä¢ Gateway:       http://localhost:8080
‚Ä¢ Identity:      http://localhost:5001
‚Ä¢ Profile:       http://localhost:5002
‚Ä¢ MemoryArchive: http://localhost:5003
‚Ä¢ AccessControl: http://localhost:5004
‚Ä¢ AuditLogging:  http://localhost:5005
‚Ä¢ Notification:  http://localhost:5006

STAGE (–ø—Ä–∏–º–µ—Ä)
‚Ä¢ Gateway:       https://stage.api.memories.local
‚Ä¢ Identity:      https://stage.identity.memories.local
...

PROD (–ø—Ä–∏–º–µ—Ä)
‚Ä¢ Gateway:       https://api.memories.app
‚Ä¢ Identity:      https://identity.memories.app
...</pre>
            </details>

            <details>
                <summary>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã JWT</summary>
<pre class="mono">HS256 (–æ–±—â–µ–µ –¥–ª—è DEV):
‚Ä¢ Jwt:Key / Secret: –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —É Identity –∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–µ–π (Profile, Memory, ...)
‚Ä¢ Jwt:Issuer (iss): "Memories.Identity"
‚Ä¢ Jwt:Audience (aud): "Memories.Users" (–∏–ª–∏ "Memories.Gateway" ‚Äî —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å)

RS256 / OIDC (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –¥–ª—è STAGE/PROD):
‚Ä¢ Jwt:Authority: https://identity.domain/.well-known/openid-configuration
‚Ä¢ Jwt:Audience:  api-–∞—É–¥–∏—Ç–æ—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "memories.api")
‚Ä¢ –ù–µ —Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ –≤ –∫–æ–Ω—Ñ–∏–≥–µ —Å–µ—Ä–≤–∏—Å–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ JWKS —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.</pre>
            </details>

            <details>
                <summary>–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è</summary>
<pre class="mono">‚Ä¢ ASPNETCORE_URLS=http://+:5000
‚Ä¢ ASPNETCORE_ENVIRONMENT=Development|Staging|Production
‚Ä¢ ConnectionStrings__Main=...
‚Ä¢ Jwt__Key / Jwt__Issuer / Jwt__Audience (HS) –∏–ª–∏ Jwt__Authority (OIDC)
‚Ä¢ Logging__LogLevel__Default=Information</pre>
            </details>
        </div>
    </section>

    <script>
        (() => {
            hljs.highlightAll();

            const method = document.getElementById('method'),
                endpointSel = document.getElementById('endpoint'),
                url = document.getElementById('url'), urlHint = document.getElementById('urlHint'),
                auth = document.getElementById('auth'), json = document.getElementById('json'),
                jsonBlock = document.getElementById('jsonBlock'), formBlock = document.getElementById('formBlock'),
                fileInput = document.getElementById('File'), filePreview = document.getElementById('filePreview'),
                sendBtn = document.getElementById('send'), fillBtn = document.getElementById('fill'),
                curlBox = document.getElementById('curl'), respEl = document.getElementById('resp'),
                statusEl = document.getElementById('status'), respHeaders = document.getElementById('respHeaders'),
                tabs = document.getElementById('tabs'), persistBodies = document.getElementById('persistBodies'),
                preview = document.getElementById('preview'), previewGrid = document.getElementById('previewGrid'),
                previewToolbar = document.getElementById('previewToolbar');

            let currentTab = 'identity', currentEndpointKey = '';
            const LS_JWT_KEY = 'memories.jwt';
            const LS_PERSIST = 'memories.persist';

            const endpoints = {
                // –í–ê–ñ–ù–û: Login ‚Äî –ø–µ—Ä–≤—ã–π!
                identity: {
                    login: {
                        label: 'Login', method: 'POST', urlTemplate: 'http://localhost:8080/identity/login', mode: 'json',
                        json: { username: 'Admin', password: 'Admin!123' },
                        hint: '–í—ã–¥–∞—ë—Ç accessToken/refreshToken ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–≤—ã–º, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å JWT.'
                    },
                    register: {
                        label: 'Register', method: 'POST', urlTemplate: 'http://localhost:8080/identity/register', mode: 'json',
                        json: { username: 'user1', password: 'User1!pass', email: 'u1@example.com', displayName: 'User 1' },
                        hint: '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.'
                    },
                    refresh: {
                        label: 'Refresh', method: 'POST', urlTemplate: 'http://localhost:8080/identity/refresh', mode: 'json',
                        json: { refreshToken: '<your-refresh-token>' },
                        hint: '–û–±–Ω–æ–≤–ª—è–µ—Ç accessToken –ø–æ refreshToken.'
                    },
                    me: {
                        label: 'Me', method: 'GET', urlTemplate: 'http://localhost:8080/identity/me', mode: 'none',
                        hint: '–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —Ç–æ–∫–µ–Ω—É (JWT –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω).'
                    }
                },

                memory: {
                    create: {
                        label: 'CreateMemory (multipart)', method: 'POST', urlTemplate: 'http://localhost:8080/memory/api/memory', mode: 'form',
                        form: { OwnerId: 'fdd2eee1-7871-45da-a3b4-c6a214ef4928', Title: 'Trip to Alps', Description: 'Ski weekend', MediaType: 'Image', AccessLevel: 'Private', Tags: 'alps,trip' },
                        hint: '–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å —Å —Ñ–∞–π–ª–æ–º (FormData + File).'
                    },
                    get: {
                        label: 'GetMemoryById', method: 'GET', urlTemplate: 'http://localhost:8080/memory/api/memory/1f6cbd66-dc14-4c35-a1f1-94928a4caa5f', mode: 'none',
                        hint: '–ü–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å—å –ø–æ –µ—ë –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É.'
                    },
                    update: {
                        label: 'UpdateMemory', method: 'PUT', urlTemplate: 'http://localhost:8080/memory/api/memory/{memoryId}', mode: 'json',
                        json: { title: 'New title', description: 'Updated', accessLevel: 'Public', tags: ['alps', 'winter'] },
                        hint: '–û–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ (–Ω–µ —Ñ–∞–π–ª—ã).'
                    },
                    delete: {
                        label: 'DeleteMemory', method: 'DELETE', urlTemplate: 'http://localhost:8080/memory/api/memory/{memoryId}', mode: 'none',
                        hint: '–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å.'
                    },

                    upload: {
                        label: 'UploadMedia (multipart)', method: 'POST', urlTemplate: 'http://localhost:8080/memory/api/memory/{memoryId}/media', mode: 'form',
                        form: { MediaType: 'Image', FileName: 'pic1.jpg' },
                        hint: '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏ (FormData + File).'
                    },
                    mediaGet: {
                        label: 'GetMediaById', method: 'GET', urlTemplate: 'http://localhost:8080/memory/api/media/{mediaId}', mode: 'none',
                        hint: '–ü–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –º–µ–¥–∏–∞ –ø–æ id.'
                    },
                    mediaUpd: {
                        label: 'UpdateMedia', method: 'PUT', urlTemplate: 'http://localhost:8080/memory/api/memory/{memoryId}/media/{mediaId}', mode: 'json',
                        json: { fileName: 'renamed.jpg', mediaType: 'Image' },
                        hint: '–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∏–ª–∏ —Å–º–µ–Ω–∏—Ç—å —Ç–∏–ø –º–µ–¥–∏–∞.'
                    },
                    mediaDel: {
                        label: 'DeleteMedia', method: 'DELETE', urlTemplate: 'http://localhost:8080/memory/api/memory/{memoryId}/media/{mediaId}', mode: 'none',
                        hint: '–£–¥–∞–ª–∏—Ç—å –º–µ–¥–∏–∞.'
                    },

                    listUser: {
                        label: 'ListByUser', method: 'GET', urlTemplate: 'http://localhost:8080/memory/api/memory/user/fdd2eee1-7871-45da-a3b4-c6a214ef4928?page=1&pageSize=10', mode: 'none',
                        hint: '–°–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (–æ–ø—Ü. —Ñ–∏–ª—å—Ç—Ä accessLevel).'
                    }
                },

                access: {
                    grant: {
                        label: 'Grant', method: 'POST', urlTemplate: 'http://localhost:8080/access-control/api/access/grant', mode: 'json',
                        json: { subjectId: '4beed3da-37f8-423b-a16b-5a0fea4bbc38', subjectType: 'User', resourceType: 'Memory', resourceId: '17e5b201-d562-4c5c-b90f-414349bca627', permission: 'Edit', expiresAt: null },
                        hint: '–í—ã–¥–∞—Ç—å –ø—Ä–∞–≤–æ –Ω–∞ —Ä–µ—Å—É—Ä—Å.'
                    },
                    revoke: {
                        label: 'Revoke', method: 'POST', urlTemplate: 'http://localhost:8080/access-control/api/access/revoke', mode: 'json',
                        json: { subjectId: '4beed3da-37f8-423b-a16b-5a0fea4bbc38', subjectType: 'User', resourceType: 'Memory', resourceId: '17e5b201-d562-4c5c-b90f-414349bca627', permission: 'Edit' },
                        hint: '–û—Ç–æ–∑–≤–∞—Ç—å –ø—Ä–∞–≤–æ.'
                    },
                    check: {
                        label: 'Check', method: 'POST', urlTemplate: 'http://localhost:8080/access-control/api/access/check', mode: 'json',
                        json: { subjectId: '8bfbdace-33b7-4764-9903-39a6dc48bf7d', resourceType: 'Memory', resourceId: '17e5b201-d562-4c5c-b90f-414349bca627', permission: 'Edit' },
                        hint: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –ø—Ä–∞–≤–æ.'
                    },
                    shares: {
                        label: 'List Shares', method: 'GET', urlTemplate: 'http://localhost:8080/access-control/api/access/memory/17e5b201-d562-4c5c-b90f-414349bca627/shares', mode: 'none',
                        hint: '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –≤—ã–¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø—ã –∫ –ø–∞–º—è—Ç–∏.'
                    }
                },

                audit: {
                    create: {
                        label: 'Create', method: 'POST', urlTemplate: 'http://localhost:8080/audit-logging/auditlogs', mode: 'json',
                        json: {
                            action: 'Access.Revoke', target: 'Memory:42', details: 'revoked by admin', result: 'success', data: '{"extra":"value"}',
                            userId: '00000000-0000-0000-0000-000000000000', timestamp: new Date().toISOString(), ipAddress: '127.0.0.1', userAgent: 'UnifiedAPI UI'
                        },
                        hint: '–°–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –∞—É–¥–∏—Ç–∞.'
                    },
                    search: {
                        label: 'Search', method: 'GET', urlTemplate: 'http://localhost:8080/audit-logging/auditlogs', mode: 'none',
                        hint: '–ü–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π –∞—É–¥–∏—Ç–∞ –ø–æ —Ñ–∏–ª—å—Ç—Ä–∞–º (?action&userId&from&to&offset&limit).'
                    },
                    getById: {
                        label: 'GetById', method: 'GET', urlTemplate: 'http://localhost:8080/audit-logging/auditlogs/0cf44724-b65d-48da-a340-0c0cb653503c', mode: 'none',
                        hint: '–ü–æ–ª—É—á–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ –∞—É–¥–∏—Ç–∞ –ø–æ id.'
                    },
                    delete: {
                        label: 'Delete', method: 'DELETE', urlTemplate: 'http://localhost:8080/audit-logging/auditlogs/{id}', mode: 'none',
                        hint: '–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∞—É–¥–∏—Ç–∞.'
                    }
                },

                notification: {
                    notifyUser: {
                        label: 'NotifyUser', method: 'POST', urlTemplate: 'http://localhost:8080/notification/api/Notification/notify', mode: 'json',
                        json: { userId: 'fdd2eee1-7871-45da-a3b4-c6a214ef4928', subject: 'Hello!', body: 'You have a new message', type: 'General' },
                        hint: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.'
                    },
                    notifyUsers: {
                        label: 'NotifyUsers', method: 'POST', urlTemplate: 'http://localhost:8080/notification/api/Notification/notify-many', mode: 'json',
                        json: { userIds: ['fdd2eee1-7871-45da-a3b4-c6a214ef4928', '00000000-0000-0000-0000-000000000124'], subject: 'Maintenance', body: 'System maintenance at 22:00', type: 'SystemAlert' },
                        hint: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.'
                    },
                    broadcast: {
                        label: 'Broadcast (501)', method: 'POST', urlTemplate: 'http://localhost:8080/notification/api/Notification/broadcast', mode: 'json',
                        json: { subject: 'Global notice', body: 'We are deploying a new version', type: 'SystemAlert' },
                        hint: '–®–∏—Ä–æ–∫–æ–≤–µ—â–∞—Ç–µ–ª—å–Ω–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ, –≤–µ—Ä–Ω—ë—Ç 501).'
                    },
                    health: {
                        label: 'Health (ready)', method: 'GET', urlTemplate: 'http://localhost:8080/notification/health/ready', mode: 'none',
                        hint: '–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞.'
                    }
                },

                profile: {
                    create: {
                        label: 'CreateProfile', method: 'POST', urlTemplate: 'http://localhost:8080/profile/api/profile', mode: 'json',
                        json: { userId: '00000000-0000-0000-0000-000000000003', fullName: 'John Doe', birthDate: '1990-05-20T00:00:00Z', displayName: 'JD', bio: 'Hello there', accessMode: 'AfterDeath', avatarUrl: null },
                        hint: '–°–æ–∑–¥–∞—ë—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.'
                    },
                    getById: {
                        label: 'GetById', method: 'GET', urlTemplate: 'http://localhost:8080/profile/api/profile/{id}', mode: 'none',
                        hint: '–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –ø—Ä–æ—Ñ–∏–ª—è.'
                    },
                    getByUser: {
                        label: 'GetByUserId', method: 'GET', urlTemplate: 'http://localhost:8080/profile/api/profile/by-user/{userId}', mode: 'none',
                        hint: '–ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.'
                    },
                    update: {
                        label: 'UpdateProfile', method: 'PUT', urlTemplate: 'http://localhost:8080/profile/api/profile/{id}', mode: 'json',
                        json: { id: '00000000-0000-0000-0000-000000000005', fullName: 'Johnathan Doe', birthDate: '1990-05-20T00:00:00Z', displayName: 'Johnny', bio: 'Updated bio', accessMode: 'AfterDeath', avatarUrl: null },
                        hint: '–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—è.'
                    },
                    delete: {
                        label: 'DeleteProfile', method: 'DELETE', urlTemplate: 'http://localhost:8080/profile/api/profile/{id}', mode: 'none',
                        hint: '–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å.'
                    },
                    confirmDeath: {
                        label: 'ConfirmDeath', method: 'POST', urlTemplate: 'http://localhost:8080/profile/api/profile/{userId}/confirm-death', mode: 'none',
                        hint: '–û—Ç–º–µ—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ DeathConfirmed.'
                    }
                }
            };

            function fillMethodList() {
                method.innerHTML = '';['GET', 'POST', 'PUT', 'DELETE'].forEach(m => {
                    const o = document.createElement('option'); o.value = m; o.textContent = m; method.appendChild(o);
                });
            }
            function fillEndpointList(tab) {
                endpointSel.innerHTML = '';
                Object.entries(endpoints[tab]).forEach(([k, v]) => {
                    const o = document.createElement('option'); o.value = k; o.textContent = v.label; endpointSel.appendChild(o);
                });
                currentEndpointKey = Object.keys(endpoints[tab])[0];
                endpointSel.value = currentEndpointKey;
            }

            function setMode(mode) {
                const isJson = mode === 'json', isForm = mode === 'form';
                jsonBlock.style.display = isJson ? '' : 'none';
                formBlock.style.display = isForm ? '' : 'none';
                updateCurl();
            }

            function applyPreset(tab, key) {
                const p = endpoints[tab][key]; if (!p) return;
                method.value = p.method; url.value = p.urlTemplate; urlHint.textContent = p.hint || '';
                setMode(p.mode);
                if (p.mode === 'json') { json.value = typeof p.json === 'string' ? p.json : JSON.stringify(p.json || {}, null, 2); }
                if (p.mode === 'form') {
                    document.getElementById('OwnerId').value = p.form?.OwnerId ?? '';
                    document.getElementById('Title').value = p.form?.Title ?? '';
                    document.getElementById('Description').value = p.form?.Description ?? '';
                    document.getElementById('MediaType').value = p.form?.MediaType ?? 'Image';
                    document.getElementById('AccessLevel').value = p.form?.AccessLevel ?? 'Private';
                    document.getElementById('Tags').value = p.form?.Tags ?? '';
                    document.getElementById('FileName').value = p.form?.FileName ?? '';
                    fileInput.value = ''; filePreview.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
                }
                updateCurl();
            }

            function ph(u) {
                return u
                    .replace('{memoryId}', '00000000-0000-0000-0000-000000000001')
                    .replace('{mediaId}', '00000000-0000-0000-0000-000000000002')
                    .replace('{userId}', '00000000-0000-0000-0000-000000000003')
                    .replace('{subjectId}', '00000000-0000-0000-0000-000000000004')
                    .replace('{id}', '00000000-0000-0000-0000-000000000005');
            }

            function escSh(s) { return s.replace(/'/g, `'\"'\"'`); }

            function buildCurl() {
                const m = method.value, u = ph(url.value);
                const token = auth.value.trim();
                const parts = [`curl -X '${m}' \\`, `  '${u}' \\`];
                if (token) parts.push(`  -H 'Authorization: Bearer ${escSh(token)}' \\`);

                if (jsonBlock.style.display !== 'none') {
                    parts.push(`  -H 'Content-Type: application/json' \\`);
                    if (json.value) parts.push(`  -d '${escSh(json.value)}'`);
                } else if (formBlock.style.display !== 'none') {
                    const ownerId = document.getElementById('OwnerId').value;
                    const title = document.getElementById('Title').value;
                    const description = document.getElementById('Description').value;
                    const mediaType = document.getElementById('MediaType').value;
                    const accessLevel = document.getElementById('AccessLevel').value;
                    const tags = document.getElementById('Tags').value;
                    const fileName = document.getElementById('FileName').value;

                    const toF = (k, v) => v ? `  -F '${k}=${escSh(v)}' \\` : '';
                    parts.push(toF('OwnerId', ownerId));
                    parts.push(toF('Title', title));
                    parts.push(toF('Description', description));
                    parts.push(toF('MediaType', mediaType));
                    parts.push(toF('AccessLevel', accessLevel));
                    if (tags) tags.split(',').map(t => t.trim()).filter(Boolean).forEach(t => parts.push(`  -F 'Tags=${escSh(t)}' \\`));
                    if (fileInput.files?.length) { const f = fileInput.files[0]; parts.push(`  -F 'File=@${escSh(f.name)}' \\`); } else { parts.push(`  -F 'File=@<path-to-file>' \\`); }
                    if (fileName) parts.push(`  -F 'FileName=${escSh(fileName)}' \\`);
                    if (parts[parts.length - 1].endsWith('\\')) parts[parts.length - 1] = parts[parts.length - 1].slice(0, -2);
                }
                return parts.filter(Boolean).join('\n');
            }
            function updateCurl() { curlBox.value = buildCurl(); }

            async function sendRequest() {
                sendBtn.disabled = true; statusEl.textContent = '‚Ä¶'; statusEl.className = 'pill ' + (method.value === 'GET' ? 'get' : 'post');
                preview.style.display = 'none'; previewGrid.innerHTML = ''; previewToolbar.style.display = 'none';
                try {
                    const u = ph(url.value);
                    const token = auth.value.trim();
                    const headers = new Headers();
                    if (token) headers.set('Authorization', `Bearer ${token}`);

                    let init = { method: method.value, headers };
                    if (jsonBlock.style.display !== 'none') {
                        headers.set('Content-Type', 'application/json');
                        init.body = json.value || '';
                    } else if (formBlock.style.display !== 'none') {
                        const fd = new FormData();
                        const ownerId = document.getElementById('OwnerId').value;
                        const title = document.getElementById('Title').value;
                        const description = document.getElementById('Description').value;
                        const mediaType = document.getElementById('MediaType').value;
                        const accessLevel = document.getElementById('AccessLevel').value;
                        const tags = document.getElementById('Tags').value;
                        const fileName = document.getElementById('FileName').value;
                        if (ownerId) fd.append('OwnerId', ownerId);
                        if (title) fd.append('Title', title);
                        if (description) fd.append('Description', description);
                        if (mediaType) fd.append('MediaType', mediaType);
                        if (accessLevel) fd.append('AccessLevel', accessLevel);
                        if (tags) tags.split(',').map(t => t.trim()).filter(Boolean).forEach(t => fd.append('Tags', t));
                        if (fileInput.files?.length) fd.append('File', fileInput.files[0], fileInput.files[0].name || 'upload.bin');
                        if (fileName) fd.append('FileName', fileName);
                        init.body = fd;
                    }

                    const res = await fetch(u, init);
                    statusEl.textContent = res.status + ' ' + res.statusText;

                    const hdrs = []; res.headers.forEach((v, k) => hdrs.push(`${k}: ${v}`)); respHeaders.value = hdrs.join('\n');

                    const ct = res.headers.get('content-type') || '';
                    let text;
                    if (ct.includes('application/json')) {
                        const j = await res.json().catch(() => ({}));
                        if (j && j.accessToken) { auth.value = j.accessToken; localStorage.setItem(LS_JWT_KEY, j.accessToken); }
                        text = JSON.stringify(j, null, 2);
                        tryRenderPreview(j);
                    } else {
                        text = await res.text();
                    }
                    respEl.textContent = text || '‚Äî'; hljs.highlightElement(respEl);
                } catch (e) {
                    statusEl.textContent = 'ERR';
                    respEl.textContent = String(e); hljs.highlightElement(respEl);
                } finally {
                    sendBtn.disabled = false; updateCurl();
                }
            }

            function tryRenderPreview(obj) {
                const mf = (obj && obj.mediaFiles) ? obj.mediaFiles
                    : (Array.isArray(obj?.items) && obj.items.length && obj.items[0]?.mediaFiles) ? obj.items[0].mediaFiles
                        : [];
                if (!Array.isArray(mf) || !mf.length) return;

                preview.style.display = 'block'; previewToolbar.style.display = 'flex';
                previewGrid.innerHTML = '';
                for (const m of mf) {
                    const item = document.createElement('div'); item.className = 'preview-item';
                    let media = ''; const mt = (m.mediaType || '').toLowerCase();
                    if (mt.includes('image')) media = `<img src="${m.url || '#'}" alt="${m.fileName || m.id}" />`;
                    else if (mt.includes('video')) media = `<video src="${m.url || '#'}" controls></video>`;
                    else if (mt.includes('audio')) media = `<audio src="${m.url || '#'}" controls></audio>`;
                    else media = `<a href="${m.url || '#'}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª</a>`;
                    item.innerHTML = `${media}<div class="meta">${m.fileName || ''}<br>${m.mediaType || ''}</div>`;
                    previewGrid.appendChild(item);
                }
            }

            // events
            sendBtn.addEventListener('click', sendRequest);
            fillBtn.addEventListener('click', () => applyPreset(currentTab, currentEndpointKey));
            endpointSel.addEventListener('change', () => { currentEndpointKey = endpointSel.value; applyPreset(currentTab, currentEndpointKey); });
            tabs.addEventListener('click', e => {
                const b = e.target.closest('[data-tab]'); if (!b) return;
                [...tabs.children].forEach(x => x.classList.toggle('active', x === b));
                currentTab = b.dataset.tab; fillEndpointList(currentTab); applyPreset(currentTab, Object.keys(endpoints[currentTab])[0]);
            });
            ['change', 'input'].forEach(ev => {
                method.addEventListener(ev, updateCurl);
                url.addEventListener(ev, updateCurl);
                auth.addEventListener(ev, updateCurl);
                json.addEventListener(ev, updateCurl);
            });

            document.getElementById('copyJwt').addEventListener('click', () => navigator.clipboard.writeText(auth.value || ''));
            document.getElementById('copyCurl').addEventListener('click', () => navigator.clipboard.writeText(curlBox.value || ''));
            persistBodies.addEventListener('change', () => localStorage.setItem(LS_PERSIST, persistBodies.checked ? '1' : '0'));
            fileInput.addEventListener('change', () => {
                if (fileInput.files?.length) {
                    const f = fileInput.files[0]; filePreview.textContent = `${f.name} (${f.type || 'binary'}, ${f.size} bytes)`;
                } else filePreview.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
                updateCurl();
            });

            // init ‚Äî —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã–≤–∞–µ–º Identity.Login
            (function init() {
                const savedJwt = localStorage.getItem(LS_JWT_KEY); if (savedJwt) auth.value = savedJwt;
                persistBodies.checked = (localStorage.getItem(LS_PERSIST) === '1');
                fillMethodList();
                currentTab = 'identity';
                fillEndpointList(currentTab);
                endpointSel.value = 'login'; currentEndpointKey = 'login';
                applyPreset('identity', 'login');
            })();
        })();
    </script>
</body>
</html>
