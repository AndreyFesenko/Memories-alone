<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8" />
    <title>Memories ‚Äì Unified API</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- highlight.js -->
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <!-- zip utils -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #111827;
            --ink: #e5e7eb;
            --muted: #9ca3af;
            --accent: #22c55e;
            --red: #ef4444;
            --yellow: #f59e0b
        }

        * { box-sizing: border-box }
        body { margin: 0; background: var(--bg); color: var(--ink); font: 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif }
        header { display: flex; gap: 16px; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid #1f2937; background: #0b1220; position: sticky; top: 0; z-index: 3 }
        header h1 { font-size: 16px; margin: 0; font-weight: 600 }
        header .env { font-size: 12px; color: var(--muted) }

        main { display: grid; grid-template-columns: 360px 1fr; gap: 16px; padding: 16px; max-width: 1500px; margin: 0 auto }

        .card { background: var(--panel); border: 1px solid #1f2937; border-radius: 12px; overflow: hidden }
        .card h3 { margin: 0; padding: 12px 14px; border-bottom: 1px solid #1f2937; font-size: 13px; letter-spacing: .2px; color: #cbd5e1 }
        .card .body { padding: 12px 14px; display: grid; gap: 10px }

        label { display: grid; gap: 6px; font-size: 12px; color: #cbd5e1 }
        input[type="text"], input[type="url"], select, textarea { width: 100%; background: #0b1220; color: var(--ink); border: 1px solid #1f2937; border-radius: 8px; padding: 9px 10px; font-size: 13px }
        textarea { min-height: 120px; resize: vertical }

        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px }

        .btn { display: inline-flex; align-items: center; gap: 8px; background: var(--accent); border: none; color: #052e16; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer }
        .btn.secondary { background: #1f2937; color: #e5e7eb }
        .btn:disabled { opacity: .6; cursor: not-allowed }
        .btn.small { padding: 4px 8px; font-size: 11px }
        .btn.ghost { background: #0b1220; color: #cbd5e1; border: 1px solid #1f2937 }
        .btn.warning { background: #f59e0b; color: #1f1300 }

        .tabs { display: flex; gap: 6px }
        .tab { padding: 6px 10px; border-radius: 8px; border: 1px solid #1f2937; background: #0b1220; color: #cbd5e1; cursor: pointer; font-size: 12px }
        .tab.active { background: #1f2937 }

        pre, code { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size: 12px }
        pre { margin: 0; white-space: pre-wrap; word-break: break-word; max-height: 520px; overflow: auto; background: #0b1220; border-top: 1px solid #1f2937; padding: 12px 14px }

        .pill { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 999px; font-weight: 600; font-size: 11px }
        .pill.get { background: #052e16; color: #86efac; border: 1px solid #166534 }
        .pill.post { background: #111827; color: #93c5fd; border: 1px solid #1d4ed8 }

        .muted { color: var(--muted); font-size: 12px }
        .divider { height: 1px; background: #1f2937; margin: 8px 0 }
        .hint { font-size: 11px; color: #a3a3a3 }
        .inline { display: flex; gap: 8px; align-items: center }
        .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px }

        details.devnotes summary { cursor: pointer; padding: 10px 14px }
        details.devnotes .body { padding-top: 0 }
        kbd { background: #0b1220; border: 1px solid #1f2937; border-radius: 6px; padding: 2px 6px; font-size: 11px }

        .file-preview { font-size: 12px; color: #cbd5e1; background: #0b1220; border: 1px dashed #334155; border-radius: 8px; padding: 8px }

        .preview { margin: 0; padding: 12px 14px; border-top: 1px solid #1f2937; }
        .preview .toolbar { display:flex; gap:8px; align-items:center; justify-content:flex-start; margin-bottom:8px; flex-wrap: wrap;}
        .preview h4 { margin: 0 0 8px 0; font-size: 13px; color: #cbd5e1; }
        .preview-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; }
        .preview-item { background: #0b1220; border: 1px solid #334155; border-radius: 10px; padding: 8px; overflow: hidden; }
        .preview-item img, .preview-item video { width: 100%; height: 130px; object-fit: cover; border-radius: 8px; display: block; }
        .preview-item audio { width: 100%; display: block; }
        .preview-item .meta { font-size: 11px; color: #9ca3af; margin-top: 6px; word-break: break-word; }
        .preview-item a { text-decoration: none; color: #93c5fd; font-size: 12px; }
        .tiny { font-size: 11px; color: #9ca3af; }
    </style>
</head>
<body>
    <header>
        <div class="inline">
            <h1>Memories ‚Äì Unified API</h1>
            <span class="env" id="env">Gateway: <code>http://localhost:8080</code></span>
        </div>
        <div class="tabs" id="tabs">
            <button class="tab active" data-tab="identity">Identity</button>
            <button class="tab" data-tab="memory">MemoryArchive</button>
        </div>
    </header>

    <main>
        <!-- LEFT: builder -->
        <section class="card">
            <h3>–ó–∞–ø—Ä–æ—Å</h3>
            <div class="body" id="reqPane">
                <div class="row">
                    <label>
                        –ú–µ—Ç–æ–¥
                        <select id="method"></select>
                    </label>
                    <label>
                        Endpoint
                        <select id="endpoint"></select>
                    </label>
                </div>

                <label>
                    URL (–ø—Ä–æ–∫—Å–∏ –≥–µ–π—Ç–≤–µ—è)
                    <input id="url" type="url" />
                    <span id="urlHint" class="hint"></span>
                </label>

                <div class="inline">
                    <label style="flex:1">
                        Authorization (Bearer)
                        <input id="auth" type="text" placeholder="–≤—Å—Ç–∞–≤—å—Ç–µ JWT –±–µ–∑ 'Bearer '" />
                    </label>
                    <button class="btn small secondary" id="copyJwt" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω">üìã</button>
                </div>
                <span class="hint">–¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ localStorage. –î–ª—è /identity/me –∏ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ Memory ‚Äî –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω.</span>

                <label class="inline">
                    <input type="checkbox" id="persistBodies" />
                    <span class="hint">–°–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –º–µ–∂–¥—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è–º–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤</span>
                </label>

                <div id="jsonBlock">
                    <label>JSON Body<textarea id="json" spellcheck="false"></textarea></label>
                </div>

                <div id="formBlock" style="display:none;">
                    <div class="grid2">
                        <label>OwnerId <input type="text" id="f_owner" placeholder="UUID" /></label>
                        <label>Title <input type="text" id="f_title" placeholder="–∑–∞–≥–æ–ª–æ–≤–æ–∫" /></label>
                    </div>
                    <label>Description <input type="text" id="f_desc" placeholder="–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ" /></label>
                    <div class="grid2">
                        <label>
                            MediaType
                            <select id="f_media">
                                <option>Image</option>
                                <option>Video</option>
                                <option>Document</option>
                                <option>Audio</option>
                                <option>Other</option>
                            </select>
                        </label>
                        <label>
                            AccessLevel
                            <select id="f_access">
                                <option value="">(–Ω–µ –∑–∞–¥–∞–≤–∞—Ç—å)</option>
                                <option>Private</option>
                                <option>Public</option>
                                <option>FriendsOnly</option>
                            </select>
                        </label>
                    </div>
                    <div class="grid2">
                        <label>MemoryId <input type="text" id="f_memoryId" placeholder="–¥–ª—è /{memoryId}" /></label>
                        <label>MediaId <input type="text" id="f_mediaId" placeholder="–¥–ª—è /{mediaId}" /></label>
                    </div>
                    <div class="grid2">
                        <label>Page <input type="number" id="f_page" value="1" min="1" /></label>
                        <label>PageSize <input type="number" id="f_pageSize" value="10" min="1" max="100" /></label>
                    </div>
                    <label>
                        AccessLevel (query –¥–ª—è ListByUser)
                        <select id="f_accessQuery">
                            <option value="">(–ª—é–±–æ–π)</option>
                            <option>Private</option>
                            <option>Public</option>
                            <option>FriendsOnly</option>
                        </select>
                    </label>
                    <label>File <input type="file" id="f_file" /></label>
                    <div id="filePreview" class="file-preview" style="display:none;"></div>
                </div>

                <div class="row">
                    <button class="btn" id="send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    <button class="btn secondary" id="fill">–ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
                </div>

                <div class="divider"></div>

                <div class="inline">
                    <label style="flex:1">
                        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π curl
                        <textarea id="curl" readonly></textarea>
                    </label>
                    <button class="btn small secondary" id="copyCurl" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å curl">üìã</button>
                </div>
            </div>
        </section>

        <!-- RIGHT: response -->
        <section class="card">
            <h3>–û—Ç–≤–µ—Ç</h3>
            <div class="body">
                <div class="inline"><span class="muted">HTTP Status:</span><span id="status" class="pill get">‚Äî</span></div>
                <label>–ó–∞–≥–æ–ª–æ–≤–∫–∏<textarea id="respHeaders" readonly></textarea></label>
            </div>
            <h3>–¢–µ–ª–æ –æ—Ç–≤–µ—Ç–∞</h3>
            <pre><code id="resp" class="language-json">‚Äî</code></pre>
            <div id="preview" class="preview" style="display:none;">
                <div class="toolbar">
                    <button class="btn small ghost" id="openAll">–û—Ç–∫—Ä—ã—Ç—å –≤—Å—ë</button>
                    <button class="btn small ghost" id="copyIds">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å mediaId</button>
                    <button class="btn small ghost" id="downloadAll">–°–∫–∞—á–∞—Ç—å –≤—Å—ë (zip)</button>
                    <button class="btn small" id="downloadAllServer">–°–∫–∞—á–∞—Ç—å –≤—Å—ë (—Å–µ—Ä–≤–µ—Ä)</button>
                    <span class="tiny" id="dlHint" style="display:none;"></span>
                </div>
            </div>
        </section>
    </main>

    <!-- Developer Notes -->
    <section class="card" style="max-width:1500px;margin:16px auto;">
        <details class="devnotes" open>
            <summary><strong>Developer Notes</strong> ‚Äî –∫–∞–∫ –≤—ã–∑—ã–≤–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∏ —á—Ç–æ –æ–∂–∏–¥–∞—Ç—å</summary>
            <div class="body">
                <h4>Identity</h4>
                <ul>
                    <li>
                        <kbd>POST</kbd> <code>/identity/login</code> ‚Äî –ª–æ–≥–∏–Ω –ø–æ username/password.
                        <br />Body: <code>{"username": "...", "password": "..."}</code>
                        <br />200 ‚Üí <code>{"accessToken": "...", "expiresAt": "ISO", "refreshToken": null|"..."} </code>
                        <br />401 ‚Üí –Ω–µ–≤–µ—Ä–Ω—ã–µ –∫—Ä–µ–¥—ã.
                    </li>
                    <li>
                        <kbd>POST</kbd> <code>/identity/register</code> ‚Äî —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
                        <br />Body: <code>{"username":"...", "password":"...", "email":"...", "displayName":"..."}</code>
                        <br />201 ‚Üí –∫–∞–∫ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ (accessToken).
                        <br />409 ‚Üí email/username –∑–∞–Ω—è—Ç—ã.
                    </li>
                    <li>
                        <kbd>POST</kbd> <code>/identity/refresh</code> ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω.
                        <br />Body: <code>{"refreshToken":"..."}</code>
                        <br />200 ‚Üí –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã.
                        <br />400 ‚Üí –Ω–µ—Ç refreshToken.
                    </li>
                    <li>
                        <kbd>GET</kbd> <code>/identity/me</code> ‚Äî –ø—Ä–æ—Ñ–∏–ª—å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
                        <br />Headers: <code>Authorization: Bearer &lt;JWT&gt;</code>
                        <br />200 ‚Üí id/claims; 401 ‚Üí –±–µ–∑/—Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º.
                    </li>
                </ul>
                <h4>MemoryArchive</h4>
                <ul>
                    <li>
                        <kbd>POST</kbd> <code>/api/memory</code> ‚Äî —Å–æ–∑–¥–∞—Ç—å Memory c —Ñ–∞–π–ª–æ–º.
                        <br />FormData: <code>OwnerId, Title, Description, MediaType, [AccessLevel], File</code>
                        <br />200 ‚Üí <code>MemoryDto</code>.
                        <br />400 ‚Üí –≤–∞–ª–∏–¥–∞—Ü–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—Ç —Ñ–∞–π–ª–∞).
                    </li>

                    <li>
                        <kbd>POST</kbd> <code>/api/memory/{memoryId}/media</code> ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª –≤ Memory.
                        <br />FormData: <code>File, MediaType</code>
                        <br />200 ‚Üí <code>MediaFileDto</code>; 404 ‚Üí memoryId –Ω–µ –Ω–∞–π–¥–µ–Ω.
                    </li>

                    <li>
                        <kbd>PUT</kbd> <code>/api/memory/{memoryId}</code> ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å Memory.
                        <br />Body JSON: <code>title, description, accessLevel</code>
                        <br />200 ‚Üí –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π <code>MemoryDto</code>; 404 ‚Äî –Ω–µ –Ω–∞–π–¥–µ–Ω.
                    </li>

                    <li>
                        <kbd>PUT</kbd> <code>/api/memory/{memoryId}/media/{mediaId}</code> ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞.
                        <br />Body JSON: <code>fileName?, mediaType?</code>
                        <br />200 ‚Üí <code>MediaFileDto</code>; 404 ‚Äî –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
                    </li>

                    <li>
                        <kbd>DELETE</kbd> <code>/api/memory/{memoryId}</code> ‚Äî —É–¥–∞–ª–∏—Ç—å Memory —Ü–µ–ª–∏–∫–æ–º.
                        <br />204 ‚Üí ok; 404 ‚Äî –Ω–µ –Ω–∞–π–¥–µ–Ω.
                    </li>

                    <li>
                        <kbd>DELETE</kbd> <code>/api/memory/{memoryId}/media/{mediaId}</code> ‚Äî —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª.
                        <br />204 ‚Üí ok; 404 ‚Äî –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
                    </li>

                    <li>
                        <kbd>GET</kbd> <code>/api/memory/{id}</code> ‚Äî –ø–æ–ª—É—á–∏—Ç—å Memory –ø–æ Id <em>(GetMemoryById)</em>.
                        <br />200 ‚Üí <code>MemoryDto</code>; 404 ‚Äî –Ω–µ –Ω–∞–π–¥–µ–Ω.
                    </li>

                    <li>
                        <kbd>GET</kbd> <code>/api/media/{id}</code> ‚Äî –ø–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–∞ <em>(GetMediaById)</em>.
                        <br />200 ‚Üí <code>MediaFileDto</code>; 404 ‚Äî –Ω–µ –Ω–∞–π–¥–µ–Ω.
                    </li>

                    <li>
                        <kbd>GET</kbd> <code>/api/memory/user/{userId}?accessLevel=&page=&pageSize=</code> ‚Äî —Å–ø–∏—Å–æ–∫ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <em>(ListByUser)</em>.
                        <br />200 ‚Üí <code>PagedResult&lt;MemoryDto&gt;</code> —Å <code>items[], totalCount, page, pageSize</code>.
                        <br /><span class="hint">–ü—Ä–µ–≤—å—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç <code>mediaFiles[].url</code>. –î–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –±–∞–∫–µ—Ç–æ–≤ ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π URL (–Ω–∞–ø—Ä., —á–µ—Ä–µ–∑ <code>PublicBaseUrl</code>) –∏–ª–∏ —Å–¥–µ–ª–∞–π—Ç–µ –±–∞–∫–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–º.</span>
                    </li>

                    <li>
                        <kbd>GET</kbd> <code>/api/memory/{id}/zip</code> ‚Äî —Å–∫–∞—á–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –æ–¥–Ω–æ–≥–æ Memory (—Å–µ—Ä–≤–µ—Ä —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç zip).
                        <br />200 ‚Üí <code>application/zip</code>; —Ç—Ä–µ–±—É–µ—Ç—Å—è <code>Authorization: Bearer JWT</code>.
                    </li>

                    <li>
                        <kbd>GET</kbd> <code>/api/memory/user/{userId}/zip?accessLevel=&page=&pageSize=</code> ‚Äî —Å–∫–∞—á–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–∏–º –∞—Ä—Ö–∏–≤–æ–º (—Å–µ—Ä–≤–µ—Ä —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç zip).
                        <br />200 ‚Üí <code>application/zip</code>; —Ç—Ä–µ–±—É–µ—Ç—Å—è <code>Authorization: Bearer JWT</code>.
                    </li>
                </ul>

            </div>
        </details>
    </section>

    <script>
        (() => {
            hljs.highlightAll();

            const method = document.getElementById('method'), endpointSel = document.getElementById('endpoint'),
                url = document.getElementById('url'), urlHint = document.getElementById('urlHint'),
                auth = document.getElementById('auth'), json = document.getElementById('json'),
                jsonBlock = document.getElementById('jsonBlock'), formBlock = document.getElementById('formBlock'),
                sendBtn = document.getElementById('send'), fillBtn = document.getElementById('fill'),
                curlBox = document.getElementById('curl'), respEl = document.getElementById('resp'),
                statusEl = document.getElementById('status'), respHeaders = document.getElementById('respHeaders'),
                previewEl = document.getElementById('preview'),
                fOwner = document.getElementById('f_owner'), fTitle = document.getElementById('f_title'),
                fDesc = document.getElementById('f_desc'), fMedia = document.getElementById('f_media'),
                fAccess = document.getElementById('f_access'), fFile = document.getElementById('f_file'),
                fMemoryId = document.getElementById('f_memoryId'), fMediaId = document.getElementById('f_mediaId'),
                fPage = document.getElementById('f_page'), fPageSize = document.getElementById('f_pageSize'),
                fAccessQuery = document.getElementById('f_accessQuery'),
                btnOpenAll = document.getElementById('openAll'), btnCopyIds = document.getElementById('copyIds'),
                btnDownloadAll = document.getElementById('downloadAll'), btnDownloadAllServer = document.getElementById('downloadAllServer'),
                dlHint = document.getElementById('dlHint'),
                copyJwt = document.getElementById('copyJwt'), copyCurl = document.getElementById('copyCurl'),
                tabs = document.getElementById('tabs'), persistBodies = document.getElementById('persistBodies'),
                filePreview = document.getElementById('filePreview');

            let currentTab = 'identity', currentEndpointKey = '';
            const LS_JWT_KEY = 'memories.jwt';
            const LS_PERSIST = 'memories.persist';
            const LS_STATE = 'memories.state.v4'; // bump version to avoid old cache

            // —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º
            let stateStore = {};
            try { stateStore = JSON.parse(localStorage.getItem(LS_STATE) || '{}') } catch { stateStore = {} }

            // keep last media for toolbar actions
            let lastMedia = []; // {url,id,name,type}

            const endpoints = {
                identity: {
                    login: {
                        label: 'Login', method: 'POST', urlTemplate: 'http://localhost:8080/identity/login', mode: 'json',
                        json: { username: 'fes', password: 'fes256!' },
                        hint: '–í–µ—Ä–Ω—ë—Ç accessToken ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ localStorage.'
                    },
                    register: {
                        label: 'CreateUser', method: 'POST', urlTemplate: 'http://localhost:8080/identity/register', mode: 'json',
                        json: { username: 'andrey', password: 'andrey256!', email: 'a@a.com', displayName: 'Andrey' }
                    },
                    refresh: {
                        label: 'Refresh JWT', method: 'POST', urlTemplate: 'http://localhost:8080/identity/refresh', mode: 'json',
                        json: { refreshToken: 'abc-refresh-token' }
                    },
                    me: {
                        label: 'Me', method: 'GET', urlTemplate: 'http://localhost:8080/identity/me', mode: 'none',
                        hint: '–¢—Ä–µ–±—É–µ—Ç—Å—è Bearer JWT'
                    }
                },
                memory: {
                    create: {
                        label: 'CreateMemory', method: 'POST', urlTemplate: 'http://localhost:8080/memory/api/memory', mode: 'form',
                        form: { OwnerId: '', Title: '', Description: '', MediaType: 'Image', AccessLevel: '' },
                        hint: 'FormData —Å —Ñ–∞–π–ª–æ–º ‚Äî —Å–º. –ø–æ–ª—è –Ω–∏–∂–µ'
                    },

                    // Presets for retrieval
                    getMemory: {
                        label: 'GetMemoryById', method: 'GET',
                        urlTemplate: 'http://localhost:8080/memory/api/memory/{memoryId}', mode: 'none',
                        hint: '–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç MemoryDto –ø–æ Id'
                    },
                    listByUser: {
                        label: 'ListByUser', method: 'GET',
                        urlTemplate: 'http://localhost:8080/memory/api/memory/user/{userId}?page=1&pageSize=10',
                        mode: 'none',
                        hint: '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã: accessLevel,page,pageSize. {userId} –±–µ—Ä—ë—Ç—Å—è –∏–∑ –ø–æ–ª—è OwnerId.'
                    },
                    getMedia: {
                        label: 'GetMediaById', method: 'GET',
                        urlTemplate: 'http://localhost:8080/memory/api/media/{mediaId}', mode: 'none',
                        hint: '–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç MediaFileDto –ø–æ Id (—Å URL, –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)'
                    },

                    upload: {
                        label: 'UploadMedia', method: 'POST', urlTemplate: 'http://localhost:8080/memory/api/memory/{memoryId}/media', mode: 'form',
                        form: { MemoryId: '', MediaType: 'Image' },
                        hint: '–ü—É—Ç—å —Ç—Ä–µ–±—É–µ—Ç {memoryId}, FormData: File/MediaType'
                    },
                    updateMemory: {
                        label: 'UpdateMemory', method: 'PUT', urlTemplate: 'http://localhost:8080/memory/api/memory/{memoryId}', mode: 'json',
                        json: { title: 'New title', description: 'Description', accessLevel: 'Private' }
                    },
                    updateMedia: {
                        label: 'UpdateMediaFile', method: 'PUT', urlTemplate: 'http://localhost:8080/memory/api/memory/{memoryId}/media/{mediaId}', mode: 'json',
                        json: { fileName: 'file.jpg', mediaType: 'Image' }
                    },
                    deleteMemory: { label: 'DeleteMemory', method: 'DELETE', urlTemplate: 'http://localhost:8080/memory/api/memory/{memoryId}', mode: 'none' },
                    deleteMedia: { label: 'DeleteMediaFile', method: 'DELETE', urlTemplate: 'http://localhost:8080/memory/api/memory/{memoryId}/media/{mediaId}', mode: 'none' }
                }
            };

            function endpointKey(tab, key) { return `${tab}.${key}` }

            function populateMethods() {
                method.innerHTML = '';['GET', 'POST', 'PUT', 'DELETE'].forEach(m => {
                    const opt = document.createElement('option'); opt.value = m; opt.textContent = m; method.appendChild(opt);
                });
            }

            function populateEndpoints(tab) {
                endpointSel.innerHTML = '';
                Object.entries(endpoints[tab]).forEach(([k, v]) => {
                    const opt = document.createElement('option'); opt.value = k; opt.textContent = v.label; endpointSel.appendChild(opt);
                });
                currentEndpointKey = Object.keys(endpoints[tab])[0];
                endpointSel.value = currentEndpointKey;
            }

            function restorePersistFlag() {
                const saved = localStorage.getItem(LS_PERSIST);
                persistBodies.checked = saved === '1';
            }

            function saveState(epKey, data) {
                if (!persistBodies.checked) return;
                stateStore[epKey] = data;
                localStorage.setItem(LS_STATE, JSON.stringify(stateStore));
            }

            function getSavedState(epKey) {
                return stateStore[epKey];
            }

            function applyPreset(tab, key) {
                const p = endpoints[tab][key]; if (!p) return;
                const epKey = endpointKey(tab, key);

                // —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const saved = getSavedState(epKey);

                const mode = saved?.mode || p.mode;
                method.value = saved?.method || p.method;
                url.value = saved?.url || p.urlTemplate;
                urlHint.textContent = p.hint || '';

                if (mode === 'json') {
                    json.value = saved?.json ?? JSON.stringify(p.json ?? {}, null, 2);
                } else if (mode === 'form') {
                    fOwner.value = saved?.form?.OwnerId ?? p.form?.OwnerId ?? '';
                    fTitle.value = saved?.form?.Title ?? p.form?.Title ?? '';
                    fDesc.value = saved?.form?.Description ?? p.form?.Description ?? '';
                    fMedia.value = saved?.form?.MediaType ?? p.form?.MediaType ?? 'Image';
                    fAccess.value = saved?.form?.AccessLevel ?? p.form?.AccessLevel ?? '';
                    fMemoryId.value = saved?.form?.MemoryId ?? '';
                    fMediaId.value = saved?.form?.MediaId ?? '';
                    fPage.value = saved?.form?.Page ?? 1;
                    fPageSize.value = saved?.form?.PageSize ?? 10;
                    fAccessQuery.value = saved?.form?.AccessQuery ?? '';
                    fFile.value = '';
                    updateFilePreview();
                }

                setMode(mode);
                updateCurl();
            }

            function pickTab(tab) {
                currentTab = tab;
                [...tabs.querySelectorAll('.tab')].forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
                populateEndpoints(tab);
                applyPreset(tab, Object.keys(endpoints[tab])[0]);
            }

            function setMode(mode) {
                jsonBlock.style.display = (mode === 'json') ? '' : 'none';
                formBlock.style.display = (mode === 'form') ? '' : 'none';
                updateCurl();
            }

            function fillPathPlaceholders(u) {
                return u
                    .replace('{memoryId}', fMemoryId.value || '{memoryId}')
                    .replace('{mediaId}', fMediaId.value || '{mediaId}')
                    .replace('{userId}', fOwner.value || '{userId}');
            }

            function buildListByUserUrl(rawUrl) {
                try {
                    const urlObj = new URL(fillPathPlaceholders(rawUrl));
                    if (currentTab === 'memory' && endpointSel.value === 'listByUser') {
                        urlObj.searchParams.set('page', String(fPage.value || 1));
                        urlObj.searchParams.set('pageSize', String(fPageSize.value || 10));
                        if (fAccessQuery.value) urlObj.searchParams.set('accessLevel', fAccessQuery.value);
                        else urlObj.searchParams.delete('accessLevel');
                    }
                    return urlObj.toString();
                } catch {
                    return fillPathPlaceholders(rawUrl);
                }
            }

            function escapeShellArg(s) { return s.replaceAll("'", "'\"'\"'") }

            function updateCurl() {
                const m = method.value;
                const rawUrl = url.value;
                let u = buildListByUserUrl(rawUrl);
                const token = auth.value.trim();
                const headers = [];
                let body = '';

                if (token) headers.push("-H 'Authorization: Bearer " + escapeShellArg(token) + "'");

                if (jsonBlock.style.display !== 'none') {
                    headers.push("-H 'Content-Type: application/json'");
                    if (json.value) body = `-d '${escapeShellArg(json.value)}'`;
                } else if (formBlock.style.display !== 'none') {
                    headers.push("-H 'Content-Type: multipart/form-data'");
                    const f = [];
                    if (fOwner.value) f.push(`-F 'OwnerId=${escapeShellArg(fOwner.value)}'`);
                    if (fTitle.value) f.push(`-F 'Title=${escapeShellArg(fTitle.value)}'`);
                    if (fDesc.value) f.push(`-F 'Description=${escapeShellArg(fDesc.value)}'`);
                    if (fMedia.value) f.push(`-F 'MediaType=${escapeShellArg(fMedia.value)}'`);
                    if (fAccess.value) f.push(`-F 'AccessLevel=${escapeShellArg(fAccess.value)}'`);
                    if (fMemoryId.value) f.push(`-F 'MemoryId=${escapeShellArg(fMemoryId.value)}'`);
                    if (fMediaId.value) f.push(`-F 'MediaId=${escapeShellArg(fMediaId.value)}'`);
                    if (fFile.files.length) {
                        const mime = fFile.files[0].type || 'application/octet-stream';
                        f.push(`-F 'File=@${escapeShellArg(fFile.files[0].name)};type=${mime}'`);
                    }
                    body = f.join(' \\\n  ');
                }

                const head = headers.join(' \\\n  ');
                const script = [`curl -X '${m}' \\`, `  '${u}' \\`, head ? `  ${head} \\` : '', body ? `  ${body}` : ''].filter(Boolean).join('\n');
                curlBox.value = script;

                // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞
                const epKey = endpointKey(currentTab, endpointSel.value);
                const stored = {
                    method: m,
                    url: rawUrl,
                    mode: (jsonBlock.style.display !== 'none') ? 'json' : ((formBlock.style.display !== 'none') ? 'form' : 'none'),
                    json: json.value,
                    form: {
                        OwnerId: fOwner.value, Title: fTitle.value, Description: fDesc.value,
                        MediaType: fMedia.value, AccessLevel: fAccess.value,
                        MemoryId: fMemoryId.value, MediaId: fMediaId.value,
                        Page: fPage.value, PageSize: fPageSize.value, AccessQuery: fAccessQuery.value
                    }
                };
                saveState(epKey, stored);
            }

            function clearPreview() {
                previewEl.style.display = "none";
                previewEl.querySelector('.toolbar').style.display = 'none';
                lastMedia = [];
                // remove old grids
                previewEl.querySelectorAll('.preview-grid').forEach(n => n.remove());
                dlHint.style.display = 'none';
                dlHint.textContent = '';
            }

            function pushMedia(mf) {
                const mt = (mf.mediaType || mf.MediaType || '').toString();
                const url = mf.url || mf.Url || '';
                const name = mf.fileName || mf.FileName || '';
                const id = mf.id || mf.Id || '';
                lastMedia.push({ url, id, name, type: mt });
            }

            function renderPreviewFromMediaArray(mediaFiles) {
                if (!Array.isArray(mediaFiles) || mediaFiles.length === 0) return false;

                const grid = document.createElement('div');
                grid.className = 'preview-grid';

                for (const mf of mediaFiles) {
                    const wrap = document.createElement('div');
                    wrap.className = 'preview-item';

                    const mt = (mf.mediaType || mf.MediaType || '').toString();
                    const url = mf.url || mf.Url || '';
                    const name = mf.fileName || mf.FileName || '';

                    pushMedia(mf);

                    const type = mt.toLowerCase();
                    if (type === 'image' && url) {
                        const img = document.createElement('img');
                        img.src = url;
                        img.alt = name || 'image';
                        wrap.appendChild(img);
                    } else if (type === 'video' && url) {
                        const vid = document.createElement('video');
                        vid.src = url; vid.controls = true;
                        wrap.appendChild(vid);
                    } else if (type === 'audio' && url) {
                        const aud = document.createElement('audio');
                        aud.src = url; aud.controls = true;
                        wrap.appendChild(aud);
                    } else if (url) {
                        const a = document.createElement('a');
                        a.href = url; a.target = '_blank';
                        a.textContent = name || (mt ? `[${mt}]` : 'file');
                        wrap.appendChild(a);
                    }

                    const meta = document.createElement('div');
                    meta.className = 'meta';
                    meta.textContent = name || url || '[no name]';
                    wrap.appendChild(meta);

                    grid.appendChild(wrap);
                }

                // show toolbar only if we have something
                const hasAny = lastMedia.length > 0;
                previewEl.querySelector('.toolbar').style.display = hasAny ? '' : 'none';

                previewEl.appendChild(grid);
                previewEl.style.display = "";
                return true;
            }

            function renderPreview(data) {
                clearPreview();
                if (!data) return;

                // Case 1: MediaFileDto
                if ((data.mediaType || data.MediaType) || (data.url || data.Url)) {
                    renderPreviewFromMediaArray([data]);
                    return;
                }

                // Case 2: MemoryDto with mediaFiles
                const mf = data.mediaFiles || data.MediaFiles;
                if (Array.isArray(mf) && mf.length) {
                    renderPreviewFromMediaArray(mf);
                    return;
                }

                // Case 3: PagedResult with .items -> MemoryDto[]
                const items = data.items || data.Items || data.memories || data.Memories;
                if (Array.isArray(items) && items.length) {
                    // collect all mediaFiles
                    const all = [];
                    for (const it of items) {
                        const m = it.mediaFiles || it.MediaFiles;
                        if (Array.isArray(m) && m.length) all.push(...m);
                    }
                    if (all.length) {
                        renderPreviewFromMediaArray(all);
                    }
                }
            }

            async function sendRequest() {
                sendBtn.disabled = true;
                statusEl.textContent = '‚Ä¶'; statusEl.className = 'pill ' + (method.value === 'GET' ? 'get' : 'post');
                try {
                    let u = buildListByUserUrl(url.value);
                    const token = auth.value.trim();
                    const headers = new Headers();
                    if (token) headers.set('Authorization', `Bearer ${token}`);

                    let body = undefined;
                    if (jsonBlock.style.display !== 'none') {
                        headers.set('Content-Type', 'application/json');
                        body = json.value || '';
                    } else if (formBlock.style.display !== 'none') {
                        const fd = new FormData();
                        if (fOwner.value) fd.append('OwnerId', fOwner.value);
                        if (fTitle.value) fd.append('Title', fTitle.value);
                        if (fDesc.value) fd.append('Description', fDesc.value);
                        if (fMedia.value) fd.append('MediaType', fMedia.value);
                        if (fAccess.value) fd.append('AccessLevel', fAccess.value);
                        if (fMemoryId.value) fd.append('MemoryId', fMemoryId.value);
                        if (fMediaId.value) fd.append('MediaId', fMediaId.value);
                        if (fFile.files.length) fd.append('File', fFile.files[0], fFile.files[0].name);
                        body = fd;
                        headers.delete('Content-Type'); // –ø—É—Å—Ç—å –±—Ä–∞—É–∑–µ—Ä –ø—Ä–æ—Å—Ç–∞–≤–∏—Ç boundary
                    }

                    const res = await fetch(u, { method: method.value, headers, body });
                    statusEl.textContent = res.status + ' ' + res.statusText;

                    const ct = res.headers.get('content-type') || '';
                    const hdrs = []; res.headers.forEach((v, k) => hdrs.push(`${k}: ${v}`));
                    respHeaders.value = hdrs.join('\n');

                    let text;
                    if (ct.includes('application/json')) {
                        const j = await res.json().catch(() => ({}));
                        if (j && j.accessToken) { // –∞–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω—è–µ–º JWT
                            auth.value = j.accessToken;
                            localStorage.setItem(LS_JWT_KEY, j.accessToken);
                        }
                        text = JSON.stringify(j, null, 2);
                        try { renderPreview(j); } catch (e) { console.warn('preview err', e); }
                    } else {
                        text = await res.text();
                        clearPreview();
                    }

                    respEl.textContent = text || '‚Äî';
                    hljs.highlightElement(respEl);
                } catch (err) {
                    statusEl.textContent = 'ERR';
                    clearPreview();
                    respEl.textContent = String(err);
                    hljs.highlightElement(respEl);
                } finally {
                    sendBtn.disabled = false;
                    updateCurl();
                }
            }

            function updateFilePreview() {
                if (!fFile.files.length) { filePreview.style.display = 'none'; filePreview.textContent = ''; return; }
                const f = fFile.files[0];
                const kb = (f.size / 1024).toFixed(1);
                filePreview.style.display = '';
                filePreview.textContent = `–ò–º—è: ${f.name}\n–†–∞–∑–º–µ—Ä: ${kb} KB\nMIME: ${f.type || 'n/a'}\n–ò–∑–º–µ–Ω—ë–Ω: ${new Date(f.lastModified).toLocaleString()}`;
            }

            // events
            sendBtn.addEventListener('click', sendRequest);
            copyJwt.addEventListener('click', () => navigator.clipboard.writeText(auth.value || ''));
            copyCurl.addEventListener('click', () => navigator.clipboard.writeText(curlBox.value || ''));
            endpointSel.addEventListener('change', () => { currentEndpointKey = endpointSel.value; applyPreset(currentTab, currentEndpointKey) });
            tabs.addEventListener('click', e => { const b = e.target.closest('[data-tab]'); if (!b) return; pickTab(b.dataset.tab) });
            fillBtn.addEventListener('click', () => applyPreset(currentTab, currentEndpointKey));

            // live rebuild & preview
            ['change', 'input'].forEach(ev => {
                method.addEventListener(ev, updateCurl);
                url.addEventListener(ev, updateCurl);
                auth.addEventListener(ev, updateCurl);
                json.addEventListener(ev, updateCurl);
                [fOwner, fTitle, fDesc, fMedia, fAccess, fMemoryId, fMediaId, fPage, fPageSize, fAccessQuery].forEach(el => el.addEventListener(ev, updateCurl));
            });
            fFile.addEventListener('change', () => { updateFilePreview(); updateCurl() });

            persistBodies.addEventListener('change', () => {
                localStorage.setItem(LS_PERSIST, persistBodies.checked ? '1' : '0');
                if (!persistBodies.checked) {
                    // –æ—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å—Ç–µ–π—Ç—ã
                    localStorage.removeItem(LS_STATE);
                    stateStore = {};
                }
            });

            // preview toolbar actions
            btnOpenAll.addEventListener('click', () => {
                if (!lastMedia.length) return;
                for (const m of lastMedia) if (m.url) try { window.open(m.url, '_blank'); } catch {}
            });
            btnCopyIds.addEventListener('click', async () => {
                if (!lastMedia.length) return;
                const ids = lastMedia.map(m => m.id).filter(Boolean);
                if (!ids.length) return;
                const txt = ids.join('\\n');
                try { await navigator.clipboard.writeText(txt); } catch {}
            });
            btnDownloadAll.addEventListener('click', async () => {
                if (!lastMedia.length) return;
                btnDownloadAll.disabled = true;
                dlHint.style.display = '';
                dlHint.textContent = '–°–∫–∞—á–∏–≤–∞–Ω–∏–µ‚Ä¶';
                try {
                    const zip = new JSZip();
                    let idx = 1;
                    for (const m of lastMedia) {
                        if (!m.url) continue;
                        const safeBase = (m.name || m.id || ('file_'+idx)).replace(/[^a-zA-Z0-9._-]+/g, '_');
                        let ext = '';
                        // try to keep extension if present in name or URL
                        const byName = (m.name || '').match(/(\.[a-zA-Z0-9]{1,6})$/);
                        const byUrl  = (m.url || '').match(/(\.[a-zA-Z0-9]{1,6})(?:\?|$)/);
                        if (byName) ext = byName[1]; else if (byUrl) ext = byUrl[1];
                        const filename = `${String(idx).padStart(2,'0')}_${safeBase}${ext}`;
                        try {
                            const resp = await fetch(m.url, { mode: 'cors' });
                            const blob = await resp.blob();
                            zip.file(filename, blob);
                        } catch (e) {
                            // add a text note if failed
                            zip.file(`${String(idx).padStart(2,'0')}_${safeBase}.failed.txt`, `Failed to fetch: ${m.url}\n${e}`);
                        }
                        idx++;
                    }
                    const content = await zip.generateAsync({ type: 'blob' });
                    saveAs(content, 'memories_media.zip');
                    dlHint.textContent = '–ì–æ—Ç–æ–≤–æ.';
                } catch (e) {
                    dlHint.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ zip (CORS/–¥–æ—Å—Ç—É–ø?).';
                } finally {
                    setTimeout(() => { dlHint.style.display = 'none'; }, 3000);
                    btnDownloadAll.disabled = false;
                }
            });
            btnDownloadAllServer.addEventListener('click', async () => {
                if (!fOwner.value) { alert('–£–∫–∞–∂–∏—Ç–µ OwnerId'); return; }
                btnDownloadAllServer.disabled = true;
                dlHint.style.display = '';
                dlHint.textContent = '–ó–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É‚Ä¶';
                try {
                    const base = `http://localhost:8080/memory/api/memory/user/${encodeURIComponent(fOwner.value)}/zip`;
                    const u = new URL(base);
                    if (fAccessQuery.value) u.searchParams.set('accessLevel', fAccessQuery.value);
                    u.searchParams.set('page', String(fPage.value || 1));
                    u.searchParams.set('pageSize', String(fPageSize.value || 50));

                    const headers = {};
                    const token = auth.value.trim();
                    if (token) headers['Authorization'] = `Bearer ${token}`;

                    const resp = await fetch(u.toString(), { headers });
                    if (!resp.ok) { alert(`ZIP error ${resp.status}`); return; }
                    const blob = await resp.blob();
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `memories_${(fOwner.value||'user')}_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`;
                    a.click();
                    setTimeout(() => URL.revokeObjectURL(a.href), 3000);
                    dlHint.textContent = '–ì–æ—Ç–æ–≤–æ.';
                } catch (e) {
                    dlHint.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ zip —Å —Å–µ—Ä–≤–µ—Ä–∞.';
                } finally {
                    setTimeout(() => { dlHint.style.display = 'none'; }, 3000);
                    btnDownloadAllServer.disabled = false;
                }
            });

            // init
            function init() {
                // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å jwt –∏ —Ñ–ª–∞–≥
                const savedJwt = localStorage.getItem(LS_JWT_KEY); if (savedJwt) auth.value = savedJwt;
                restorePersistFlag();

                populateMethods();
                pickTab('identity');
                updateCurl();
            }
            init();
        })();
    </script>
</body>
</html>
