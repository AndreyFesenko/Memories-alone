<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Memories API Gateway Test UI</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, textarea, select, button { width: 100%; padding: 8px; margin-top: 5px; }
    button { width: auto; margin-top: 10px; }
    pre { background: #f4f4f4; padding: 10px; border: 1px solid #ccc; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>Memories API Gateway Test UI</h1>

  <div>
    <label>Base URL:</label>
    <input type="text" id="baseUrl" value="https://api-gateway-cqvi.onrender.com" />

    <label>JWT Token:</label>
    <input type="text" id="jwtToken" placeholder="JWT will appear here after login" />
    <button onclick="logout()">Logout (Clear Token)</button>

    <label>Select Example Route:</label>
    <select id="exampleRoutes" onchange="applyRoute(this.value)">
      <option value="">-- Choose a route --</option>
      <option value="/identity/login|POST">{Identity} Login</option>
      <option value="/identity/register|POST">{Identity} Register</option>
      <option value="/profile|GET">{Profile} Get My Profile</option>
      <option value="/profile/update|PUT">{Profile} Update Profile</option>
      <option value="/memory|POST">{Memory} Create Memory</option>
      <option value="/memory/{id}|GET">{Memory} Get Memory by Id</option>
      <option value="/notification|GET">{Notification} Get My Notifications</option>
      <option value="/access-control|GET">{AccessControl} Get Access Rules</option>
      <option value="/audit-logging|GET">{AuditLogging} Get Audit Logs</option>
    </select>

    <label>Test GUID (for {id}):</label>
    <input type="text" id="testGuid" value="11111111-1111-1111-1111-111111111111" />

    <label>Request Path:</label>
    <input type="text" id="path" placeholder="/identity/login" />

    <label>HTTP Method:</label>
    <select id="method">
      <option>GET</option>
      <option>POST</option>
      <option>PUT</option>
      <option>DELETE</option>
    </select>

    <label>Request Body (JSON):</label>
    <textarea id="body" rows="6" placeholder='{"email":"test@test.com","password":"123456"}'></textarea>

    <button onclick="sendRequest()">Send Request</button>
  </div>

  <h2>Response:</h2>
  <textarea id="responseOutput" rows="15"></textarea>

  <script>
    function applyRoute(value) {
      if (!value) return;
      const [path, method] = value.split("|");
      let finalPath = path;

      if (finalPath.includes("{id}")) {
        const testGuid = document.getElementById("testGuid").value.trim();
        finalPath = finalPath.replace("{id}", testGuid);
      }

      document.getElementById("path").value = finalPath;
      if (method) document.getElementById("method").value = method;

      if (method === "POST") {
        document.getElementById("body").value = JSON.stringify(
          { email: "test@test.com", password: "123456" },
          null,
          2
        );
      } else {
        document.getElementById("body").value = "";
      }
    }

    async function sendRequest() {
      const baseUrl = document.getElementById("baseUrl").value.trim();
      const path = document.getElementById("path").value.trim();
      const method = document.getElementById("method").value;
      const token = document.getElementById("jwtToken").value.trim();
      let body = document.getElementById("body").value.trim();

      const url = baseUrl + path;
      const headers = { "Content-Type": "application/json" };
      if (token) headers["Authorization"] = "Bearer " + token;

      const options = { method, headers };
      if (body && method !== "GET") {
        try { options.body = JSON.stringify(JSON.parse(body)); }
        catch { return alert("Invalid JSON body"); }
      }

      try {
        const res = await fetch(url, options);
        const text = await res.text();
        document.getElementById("responseOutput").value = text;

        if (path.includes("login") && res.ok) {
          try {
            const json = JSON.parse(text);
            if (json.token) {
              document.getElementById("jwtToken").value = json.token;
              localStorage.setItem("jwtToken", json.token);
              document.getElementById("responseOutput").value =
                "Login successful. JWT saved.\n\n" + text;
            }
          } catch {}
        }
      } catch (err) {
        document.getElementById("responseOutput").value = "Error: " + err;
      }
    }

    function logout() {
      document.getElementById("jwtToken").value = "";
      document.getElementById("path").value = "";
      document.getElementById("body").value = "";
      document.getElementById("method").value = "GET";
      localStorage.removeItem("jwtToken");
      document.getElementById("responseOutput").value = "Logged out. Token and fields cleared.";
    }

    window.onload = () => {
      const savedToken = localStorage.getItem("jwtToken");
      if (savedToken) document.getElementById("jwtToken").value = savedToken;
    };
  </script>
</body>
</html>
